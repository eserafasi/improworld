<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda ImproWorld · Calendario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <style>
    :root {
      --ink: #101828;
      --muted: #667085;
      --bg: #f8fafc;
      --card: #ffffff;
      --primary: #7c3aed;
      --primary-soft: rgba(124, 58, 237, 0.12);
      --accent: #f59e0b;
      --accent-soft: rgba(245, 158, 11, 0.14);
      --success: #22c55e;
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --shadow-sm: 0 6px 20px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 18px 48px rgba(79, 70, 229, 0.12);
      --max-width: 1200px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #faf5ff 0%, #f8fafc 45%, #ffffff 100%);
      color: var(--ink);
    }

    [v-cloak] {
      display: none !important;
    }

    .page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .hero {
      padding: 64px 20px 36px;
      background: radial-gradient(120% 120% at 50% 0%, rgba(124, 58, 237, 0.14) 0%, rgba(124, 58, 237, 0) 60%),
        linear-gradient(140deg, rgba(124, 58, 237, 0.12) 10%, rgba(59, 130, 246, 0.08) 100%);
    }

    .hero__inner {
      max-width: var(--max-width);
      margin: 0 auto;
      display: grid;
      gap: 28px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(2.2rem, 5vw, 3.2rem);
      line-height: 1.05;
      letter-spacing: -0.02em;
    }

    .hero p {
      margin: 0;
      font-size: 1.05rem;
      color: rgba(16, 24, 40, 0.78);
      max-width: 60ch;
    }

    .hero__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .hero__meta strong {
      color: var(--primary);
    }

    main {
      flex: 1;
      padding: 0 20px 72px;
    }

    .wrap {
      max-width: var(--max-width);
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    .calendar-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(124, 58, 237, 0.16);
      padding: 24px;
      display: grid;
      gap: 24px;
    }

    .calendar-card__header {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .calendar-card__actions {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      justify-content: flex-end;
    }

    .calendar-card__title {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .calendar-card__title h2 {
      margin: 0;
      font-size: clamp(1.6rem, 4vw, 2.2rem);
      letter-spacing: -0.01em;
    }

    .calendar-card__title span {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .calendar-controls {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: rgba(124, 58, 237, 0.08);
      padding: 8px 12px;
      border-radius: 999px;
    }

    .calendar-controls button {
      appearance: none;
      border: none;
      background: var(--card);
      color: var(--primary);
      border-radius: 999px;
      padding: 10px 14px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      box-shadow: 0 8px 24px rgba(124, 58, 237, 0.18);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .calendar-controls button:hover,
    .calendar-controls button:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 12px 32px rgba(124, 58, 237, 0.24);
      outline: none;
    }

    .view-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(124, 58, 237, 0.08);
      padding: 8px;
      border-radius: 999px;
    }

    .view-toggle button {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.9rem;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .view-toggle button[aria-pressed="true"] {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    .calendar-month {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .netflix-month {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .month-row {
      background: rgba(255, 255, 255, 0.88);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(226, 232, 240, 0.9);
      padding: 18px 20px 20px;
      display: grid;
      gap: 16px;
      box-shadow: 0 10px 32px rgba(15, 23, 42, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .month-row:hover,
    .month-row:focus-within {
      transform: translateY(-2px);
      box-shadow: 0 18px 44px rgba(15, 23, 42, 0.16);
    }

    .month-row--today {
      border-color: rgba(124, 58, 237, 0.45);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.18);
    }

    .month-row__header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: baseline;
      justify-content: space-between;
    }

    .month-row__title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .month-row__day {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .month-row__date {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .month-row__badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      font-size: 0.78rem;
      padding: 6px 12px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
    }

    .month-row__scroller {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .month-row__scroller::-webkit-scrollbar {
      height: 8px;
    }

    .month-row__scroller::-webkit-scrollbar-thumb {
      background: rgba(124, 58, 237, 0.24);
      border-radius: 999px;
    }

    .show-card {
      flex: 0 0 clamp(220px, 26vw, 280px);
      display: grid;
      gap: 10px;
      background: rgba(124, 58, 237, 0.08);
      border-radius: var(--radius-md);
      padding: 12px;
      border: 1px solid rgba(124, 58, 237, 0.16);
      scroll-snap-align: start;
      box-shadow: 0 10px 28px rgba(124, 58, 237, 0.16);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .show-card:hover,
    .show-card:focus-within {
      transform: translateY(-4px);
      box-shadow: 0 16px 40px rgba(124, 58, 237, 0.22);
    }

    .show-card__thumb {
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: rgba(124, 58, 237, 0.16);
      aspect-ratio: 16 / 9;
      position: relative;
    }

    .show-card__thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .show-card__body {
      display: grid;
      gap: 6px;
    }

    .show-card__title {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--ink);
    }

    .show-card__meta {
      display: grid;
      gap: 4px;
      font-size: 0.85rem;
      color: rgba(15, 23, 42, 0.76);
    }

    .month-row__empty {
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(248, 250, 252, 0.75);
      border-radius: var(--radius-md);
      padding: 24px;
      text-align: center;
      gap: 16px;
    }

    .month-row__cta {
      appearance: none;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--shadow-sm);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .month-row__cta:hover,
    .month-row__cta:focus-visible {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      outline: none;
    }

    .month-row__summary {
      font-size: 0.9rem;
      color: rgba(16, 24, 40, 0.7);
    }

    .agenda-view {
      display: grid;
      gap: 20px;
    }

    .agenda-list {
      display: grid;
      gap: 20px;
    }

    .agenda-card {
      display: grid;
      grid-template-columns: clamp(140px, 30vw, 200px) minmax(0, 1fr);
      gap: 18px;
      background: rgba(255, 255, 255, 0.82);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(124, 58, 237, 0.16);
      box-shadow: 0 12px 28px rgba(79, 70, 229, 0.15);
      padding: 18px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .agenda-card:hover,
    .agenda-card:focus-within {
      transform: translateY(-3px);
      box-shadow: 0 20px 44px rgba(79, 70, 229, 0.22);
    }

    .agenda-card__thumb {
      border-radius: var(--radius-md);
      overflow: hidden;
      background: rgba(124, 58, 237, 0.18);
      aspect-ratio: 3 / 4;
    }

    .agenda-card__thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .agenda-card__body {
      display: grid;
      gap: 10px;
    }

    .agenda-card__heading {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .agenda-card__title {
      margin: 0;
      font-size: 1.2rem;
      font-weight: 600;
      letter-spacing: -0.01em;
    }

    .agenda-card__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 16px;
      font-size: 0.9rem;
      color: rgba(15, 23, 42, 0.76);
    }

    .agenda-card__meta strong {
      color: var(--primary);
    }

    .agenda-card__footer {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .agenda-card__tag {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.78rem;
      background: rgba(124, 58, 237, 0.12);
      color: var(--primary);
      font-weight: 600;
    }

    .agenda-card__cta {
      appearance: none;
      border: none;
      background: var(--primary);
      color: white;
      font-weight: 600;
      border-radius: 999px;
      padding: 8px 16px;
      cursor: pointer;
      text-decoration: none;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      box-shadow: var(--shadow-sm);
    }

    .agenda-card__cta:hover,
    .agenda-card__cta:focus-visible {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      outline: none;
    }

    .agenda-card__description {
      font-size: 0.95rem;
      color: rgba(16, 24, 40, 0.74);
    }

    .day__badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      border-radius: 999px;
      font-size: 0.78rem;
      padding: 6px 10px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
    }

    .empty {
      text-align: center;
      color: var(--muted);
      padding: 48px 0;
      font-size: 1rem;
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--muted);
      font-size: 1rem;
    }

    .loading::before {
      content: "";
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 3px solid rgba(124, 58, 237, 0.16);
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 960px) {
      .month-row {
        padding: 16px;
      }

      .month-row__scroller {
        gap: 12px;
      }

      .show-card {
        flex-basis: clamp(200px, 48vw, 240px);
      }

      .agenda-card {
        grid-template-columns: minmax(0, 1fr);
      }

      .agenda-card__thumb {
        aspect-ratio: 16 / 9;
      }
    }

    @media (max-width: 640px) {
      .calendar-card {
        padding: 20px;
      }

      .calendar-card__header {
        align-items: stretch;
      }

      .calendar-card__actions {
        flex-direction: column;
        align-items: stretch;
      }

      .calendar-controls,
      .view-toggle {
        width: 100%;
        justify-content: space-between;
      }

      .month-row {
        padding: 14px;
      }

      .month-row__header {
        align-items: flex-start;
      }

      .month-row__badge {
        margin-top: 8px;
      }

      .show-card {
        flex-basis: clamp(200px, 72vw, 260px);
      }

      .agenda-card {
        padding: 16px;
      }

      .agenda-card__footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>
<body>
  <div id="app" class="page" v-cloak>
    <header class="hero">
      <div class="hero__inner">
        <div>
          <h1>Agenda ImproWorld · Calendario</h1>
          <p>
            Visualiza todos los eventos de improvisación en un calendario mensual. Filtramos los datos publicados en la agenda y los agrupamos automáticamente por día para que planifiques tus asistencias de un vistazo.
          </p>
        </div>
        <div class="hero__meta">
          <span><strong>{{ totalEventos }}</strong> eventos publicados</span>
          <span>Actualizado el <strong>{{ ultimaActualizacion }}</strong></span>
        </div>
      </div>
    </header>

    <main>
      <div class="wrap">
        <section class="calendar-card">
          <div class="calendar-card__header">
            <div class="calendar-card__title">
              <h2 id="calendar-title">{{ mesActualLabel }}</h2>
              <span role="status" aria-live="polite">
                <template v-if="visibleEventosMes === 1">1 evento visible este mes</template>
                <template v-else>{{ visibleEventosMes }} eventos visibles este mes</template>
              </span>
            </div>
            <div class="calendar-card__actions">
              <div class="calendar-controls" role="group" aria-label="Cambiar de mes">
                <button type="button" @click="cambiarMes(-1)" aria-label="Ir al mes anterior">←</button>
                <span aria-hidden="true">{{ mesActualCorto }}</span>
                <button type="button" @click="cambiarMes(1)" aria-label="Ir al mes siguiente">→</button>
              </div>
              <div class="view-toggle" role="group" aria-label="Cambiar vista del calendario">
                <button
                  type="button"
                  :aria-pressed="vista === 'month'"
                  @click="vista = 'month'"
                >Vista mensual (estilo Netflix)</button>
                <button
                  type="button"
                  :aria-pressed="vista === 'agenda'"
                  @click="vista = 'agenda'"
                >Vista agenda (lista)</button>
              </div>
            </div>
          </div>

          <div v-if="error" class="empty">{{ error }}</div>
          <div v-else-if="cargando" class="loading">Cargando eventos…</div>
          <template v-else>
            <div v-if="vista === 'month'" class="calendar-month netflix-month" role="list" aria-labelledby="calendar-title">
              <!--
                Vista mensual tipo carrusel: cada fila representa un día del mes, mantiene ancho estable para las tarjetas y usa
                scroll horizontal con snap para minimizar saltos de diseño. Se reutiliza el mapa de eventos existente sin
                alterar la fuente de datos ni dependencias adicionales. Las jornadas vacías muestran un CTA para registrar
                shows, mientras que los días con actividades mantienen foco y hover para accesibilidad. Limitación actual:
                los eventos sin flyer muestran un bloque de color sólido, se puede mejorar con placeholders personalizados.
              -->
              <article
                v-for="day in diasDelMes"
                :key="day.iso"
                class="month-row"
                :class="{ 'month-row--today': day.esHoy }"
                role="listitem"
                :aria-label="descripcionFila(day)"
              >
                <header class="month-row__header">
                  <div class="month-row__title">
                    <span class="month-row__day">{{ diaSemanaCorta(day.iso) }} · {{ day.numero }}</span>
                    <span class="month-row__date">{{ fechaLarga(day.iso) }}</span>
                  </div>
                  <span class="month-row__badge">{{ day.eventos.length }} · {{ day.eventos.length === 1 ? 'evento' : 'eventos' }}</span>
                </header>
                <div v-if="day.eventos.length" class="month-row__scroller" role="group" :aria-label="`Eventos del ${fechaLarga(day.iso)}`">
                  <article
                    v-for="evento in day.eventos"
                    :key="evento.id"
                    class="show-card"
                    role="group"
                    :aria-label="`Evento ${evento.nombre}`"
                  >
                    <div class="show-card__thumb" v-if="evento.flyerUrl">
                      <img :src="evento.flyerUrl" :alt="`Flyer del evento ${evento.nombre}`" loading="lazy" />
                    </div>
                    <div class="show-card__thumb" v-else aria-hidden="true"></div>
                    <div class="show-card__body">
                      <h3 class="show-card__title">{{ evento.nombre }}</h3>
                      <div class="show-card__meta">
                        <span><strong>{{ evento.horaLabel }}</strong></span>
                        <span>{{ evento.lugarLabel }}</span>
                        <span v-if="evento.ciudadLabel">{{ evento.ciudadLabel }}</span>
                      </div>
                    </div>
                  </article>
                </div>
                <div v-else class="month-row__empty">
                  <span class="month-row__summary">No hay eventos para este día.</span>
                  <a class="month-row__cta" href="../registro.html">¿Tienes un show? Regístralo</a>
                </div>
              </article>
              <p v-if="!diasDelMes.length" class="empty">No hay eventos programados para este mes.</p>
            </div>
            <div v-else class="agenda-view" role="list" aria-labelledby="calendar-title">
              <div v-if="agendaEventos.length" class="agenda-list">
                <article
                  v-for="evento in agendaEventos"
                  :key="`agenda-${evento.id}-${evento.diaISO}`"
                  class="agenda-card"
                  role="listitem"
                  :aria-label="`Evento ${evento.nombre} el ${evento.resumenFecha}`"
                >
                  <div class="agenda-card__thumb" v-if="evento.flyerUrl">
                    <img :src="evento.flyerUrl" :alt="`Flyer del evento ${evento.nombre}`" loading="lazy" />
                  </div>
                  <div class="agenda-card__thumb" v-else aria-hidden="true"></div>
                  <div class="agenda-card__body">
                    <div class="agenda-card__heading">
                      <h3 class="agenda-card__title">{{ evento.nombre }}</h3>
                      <div class="agenda-card__meta">
                        <span><strong>{{ evento.resumenFecha }}</strong></span>
                        <span>{{ evento.horaLabel }}</span>
                        <span>{{ evento.lugarLabel }}</span>
                        <span v-if="evento.ciudadLabel">{{ evento.ciudadLabel }}</span>
                      </div>
                    </div>
                    <div class="agenda-card__footer">
                      <span class="agenda-card__tag" v-if="evento.formato">{{ evento.formato }}</span>
                      <span class="agenda-card__tag" v-if="!evento.formato && evento.pais">{{ evento.pais }}</span>
                      <a
                        v-if="evento.boleteria"
                        class="agenda-card__cta"
                        :href="evento.boleteria"
                        target="_blank"
                        rel="noopener"
                      >Comprar boletas</a>
                    </div>
                    <p v-if="evento.descripcion" class="agenda-card__description">{{ evento.descripcion }}</p>
                  </div>
                </article>
              </div>
              <p v-else class="empty">No hay eventos programados para este mes.</p>
            </div>
          </template>
        </section>
      </div>
    </main>
  </div>

  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwoCLUfEiRjnmzumQ-Qs82vLUMpfTWHuemY8W6NODHVhGskbdQQHh-rIHKJUpS0cPCSxQ/exec";

  function val(x) {
    return x === undefined || x === null ? "" : String(x).trim();
  }

  function formatFecha(v) {
    if (!v) return "";
    const d = new Date(v);
    if (isNaN(d)) return "";
    return d.toISOString().split("T")[0];
  }

  function createFallbackId() {
    try {
      if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
        return crypto.randomUUID();
      }
    } catch (_) {
      // ignore
    }
    return `event-${Date.now()}-${Math.random().toString(16).slice(2)}`;
  }

  function parseHora(value) {
    if (!value) return { label: "Horario por confirmar", minutes: Number.POSITIVE_INFINITY };
    const clean = String(value).trim();
    const match = clean.match(/(\d{1,2})(?::(\d{2}))?/);
    if (!match) {
      return { label: clean, minutes: Number.POSITIVE_INFINITY };
    }
    const hours = Number.parseInt(match[1], 10);
    const minutes = Number.parseInt(match[2] ?? "0", 10);
    if (Number.isNaN(hours) || Number.isNaN(minutes)) {
      return { label: clean, minutes: Number.POSITIVE_INFINITY };
    }
    const label = `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`;
    return { label, minutes: hours * 60 + minutes };
  }

  function norm(ev) {
    const fechaISO = formatFecha(ev.FechaFuncion || ev.fecha || ev.fechaRaw);
    const horaInfo = parseHora(val(ev.HoraFuncionTexto) || val(ev.HoraFuncion));
    return {
      id: val(ev.Id) || val(ev.ID) || createFallbackId(),
      nombre: val(ev.NombreFormato) || val(ev["Nombre de la Obra"]) || "Evento sin nombre",
      fechaISO,
      horaLabel: horaInfo.label,
      horaValue: horaInfo.minutes,
      ciudadLabel: val(ev.Ciudad) || val(ev.Pais) || val(ev["País"]) || "",
      lugarLabel: val(ev.Lugar) || "Ubicación por confirmar",
      pais: val(ev.Pais) || val(ev["País"]),
      flyerUrl:
        val(ev.FlyerURL) ||
        val(ev.Flyer) ||
        val(ev.FlyerWeb) ||
        val(ev.Poster) ||
        val(ev.Imagen) ||
        val(ev.ImagenFlyer) ||
        "",
      formato: val(ev.Formato) || val(ev.FormatoObra) || val(ev["Formato de la Obra"]) || "",
      boleteria:
        val(ev.Boleteria) ||
        val(ev.LinkBoleteria) ||
        val(ev["Link Boleteria"]) ||
        val(ev["Link boletos"]) ||
        "",
      descripcion: val(ev.Descripcion) || val(ev.Descripción) || "",
      estado: val(ev.Estado) || "Publicado",
    };
  }

  const { createApp, ref, computed, onMounted } = Vue;

  createApp({
    setup() {
      const cargando = ref(true);
      const error = ref("");
      const lista = ref([]);
      const hoy = new Date();
      const hoyISO = new Date(hoy.getTime() - hoy.getTimezoneOffset() * 60000).toISOString().split("T")[0];
      const mesActual = ref(new Date(hoy.getFullYear(), hoy.getMonth(), 1));
      const ultimaActualizacion = ref(new Date().toLocaleDateString("es-ES", { dateStyle: "long" }));
      const vista = ref("month");

      const eventosPorDia = computed(() => {
        const map = new Map();
        for (const item of lista.value) {
          if (!item.fechaISO || item.estado === "Despublicado") continue;
          if (!map.has(item.fechaISO)) {
            map.set(item.fechaISO, []);
          }
          map.get(item.fechaISO).push(item);
        }
        for (const events of map.values()) {
          events.sort((a, b) => a.horaValue - b.horaValue || a.nombre.localeCompare(b.nombre, "es"));
        }
        return map;
      });

      const totalEventos = computed(() => lista.value.filter((ev) => ev.estado !== "Despublicado").length);

      const dias = computed(() => {
        const base = new Date(mesActual.value.getTime());
        base.setDate(1);
        const offset = (base.getDay() + 6) % 7; // Monday as first day
        const inicio = new Date(base.getTime());
        inicio.setDate(inicio.getDate() - offset);
        const celdas = [];
        for (let i = 0; i < 42; i += 1) {
          const d = new Date(inicio.getTime());
          d.setDate(inicio.getDate() + i);
          const iso = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().split("T")[0];
          const fechaLocal = new Date(`${iso}T00:00:00`);
          const weekdayLongRaw = fechaLocal.toLocaleDateString("es-ES", { weekday: "long" });
          const weekdayShortRaw = fechaLocal.toLocaleDateString("es-ES", { weekday: "short" });
          const monthLongRaw = fechaLocal.toLocaleDateString("es-ES", { day: "numeric", month: "long" });
          const eventos = eventosPorDia.value.get(iso) || [];
          celdas.push({
            iso,
            numero: d.getDate(),
            mesActual: d.getMonth() === mesActual.value.getMonth(),
            esHoy: iso === hoyISO,
            eventos,
            weekdayLong: weekdayLongRaw.charAt(0).toUpperCase() + weekdayLongRaw.slice(1),
            weekdayShort: weekdayShortRaw.charAt(0).toUpperCase() + weekdayShortRaw.slice(1),
            fechaLabel: monthLongRaw.charAt(0).toUpperCase() + monthLongRaw.slice(1),
          });
        }
        return celdas;
      });

      const diasDelMes = computed(() => dias.value.filter((day) => day.mesActual));

      const agendaEventos = computed(() => {
        const items = [];
        for (const day of diasDelMes.value) {
          for (const evento of day.eventos) {
            items.push({
              ...evento,
              resumenFecha: `${day.weekdayLong} · ${day.fechaLabel}`,
              diaISO: day.iso,
            });
          }
        }
        return items.sort((a, b) => {
          if (a.fechaISO !== b.fechaISO) {
            return a.fechaISO.localeCompare(b.fechaISO);
          }
          return a.horaValue - b.horaValue;
        });
      });

      const visibleEventosMes = computed(() => {
        return diasDelMes.value.reduce((acc, day) => acc + day.eventos.length, 0);
      });

      const mesActualLabel = computed(() =>
        mesActual.value.toLocaleDateString("es-ES", { month: "long", year: "numeric" })
      );

      const mesActualCorto = computed(() =>
        mesActual.value.toLocaleDateString("es-ES", { month: "short", year: "numeric" })
      );

      function cambiarMes(delta) {
        const nuevo = new Date(mesActual.value.getTime());
        nuevo.setMonth(nuevo.getMonth() + delta, 1);
        mesActual.value = nuevo;
      }

      function fechaLarga(iso) {
        const fecha = new Date(`${iso}T00:00:00`);
        const baseRaw = fecha.toLocaleDateString("es-ES", {
          weekday: "long",
          day: "numeric",
          month: "long",
        });
        return baseRaw.charAt(0).toUpperCase() + baseRaw.slice(1);
      }

      function diaSemanaCorta(iso) {
        const fecha = new Date(`${iso}T00:00:00`);
        const raw = fecha.toLocaleDateString("es-ES", { weekday: "short" });
        return raw.charAt(0).toUpperCase() + raw.slice(1);
      }

      function descripcionFila(day) {
        const base = fechaLarga(day.iso);
        if (!day.eventos.length) {
          return `${base}. Sin eventos.`;
        }
        const cantidad = day.eventos.length === 1 ? "Un evento" : `${day.eventos.length} eventos`;
        return `${base}. ${cantidad}.`;
      }

      async function cargar() {
        cargando.value = true;
        error.value = "";
        try {
          const response = await fetch(WEBAPP_URL);
          if (!response.ok) {
            throw new Error(`No se pudo cargar la agenda (${response.status})`);
          }
          const data = await response.json();
          lista.value = Array.isArray(data) ? data.map(norm) : [];
          ultimaActualizacion.value = new Date().toLocaleDateString("es-ES", { dateStyle: "long" });
        } catch (err) {
          console.error("Error al cargar la agenda", err);
          error.value = "No fue posible cargar los eventos. Intenta de nuevo más tarde.";
          lista.value = [];
        } finally {
          cargando.value = false;
        }
      }

      onMounted(() => {
        cargar();
      });

      return {
        cargando,
        error,
        cambiarMes,
        mesActualLabel,
        mesActualCorto,
        visibleEventosMes,
        totalEventos,
        ultimaActualizacion,
        vista,
        diasDelMes,
        agendaEventos,
        fechaLarga,
        diaSemanaCorta,
        descripcionFila,
      };
    }
  }).mount("#app");
  </script>
</body>
</html>
