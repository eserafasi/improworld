<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agenda ImproWorld ¬∑ Calendario</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
    rel="stylesheet"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <style>
    :root {
      --ink: #101828;
      --muted: #667085;
      --bg: #f8fafc;
      --card: #ffffff;
      --primary: #7c3aed;
      --primary-soft: rgba(124, 58, 237, 0.12);
      --accent: #f59e0b;
      --accent-soft: rgba(245, 158, 11, 0.14);
      --success: #22c55e;
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --shadow-sm: 0 6px 20px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 18px 48px rgba(79, 70, 229, 0.12);
      --max-width: 1200px;
    }

    *, *::before, *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #faf5ff 0%, #f8fafc 45%, #ffffff 100%);
      color: var(--ink);
    }

    [v-cloak] {
      display: none !important;
    }

    .page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .hero {
      padding: 64px 20px 36px;
      background: radial-gradient(120% 120% at 50% 0%, rgba(124, 58, 237, 0.14) 0%, rgba(124, 58, 237, 0) 60%),
        linear-gradient(140deg, rgba(124, 58, 237, 0.12) 10%, rgba(59, 130, 246, 0.08) 100%);
    }

    .hero__inner {
      max-width: var(--max-width);
      margin: 0 auto;
      display: grid;
      gap: 28px;
    }

    .hero h1 {
      margin: 0;
      font-size: clamp(2.2rem, 5vw, 3.2rem);
      line-height: 1.05;
      letter-spacing: -0.02em;
    }

    .hero p {
      margin: 0;
      font-size: 1.05rem;
      color: rgba(16, 24, 40, 0.78);
      max-width: 60ch;
    }

    .hero__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .hero__meta strong {
      color: var(--primary);
    }

    main {
      flex: 1;
      padding: 0 20px 72px;
    }

    .wrap {
      max-width: var(--max-width);
      margin: 0 auto;
      display: grid;
      gap: 24px;
    }

    .calendar-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(124, 58, 237, 0.16);
      padding: 16px 18px;
      display: grid;
      gap: 16px;
    }

    .calendar-card__header {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      justify-content: space-between;
    }

    .calendar-card__actions {
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      gap: 8px;
      justify-content: flex-end;
    }

    .calendar-card__actions > * {
      flex: 0 1 auto;
      white-space: nowrap;
    }

    .calendar-card__title {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .calendar-card__title h2 {
      margin: 0;
      font-size: clamp(1.4rem, 3.6vw, 1.9rem);
      letter-spacing: -0.01em;
    }

    .calendar-card__title span {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .calendar-controls {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: rgba(124, 58, 237, 0.08);
      padding: 3px 5px;
      border-radius: 999px;
      font-size: 0.5rem;
    }

    .calendar-controls button {
      appearance: none;
      border: none;
      background: var(--card);
      color: var(--primary);
      border-radius: 999px;
      padding: 3px 5px;
      font-weight: 600;
      font-size: 0.425rem;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(124, 58, 237, 0.18);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .calendar-controls button:hover,
    .calendar-controls button:focus-visible {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(124, 58, 237, 0.24);
      outline: none;
    }

    .view-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(124, 58, 237, 0.08);
      padding: 6px;
      border-radius: 999px;
    }

    .view-toggle button {
      appearance: none;
      border: none;
      background: transparent;
      color: var(--muted);
      font-weight: 600;
      font-size: 0.85rem;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.2s ease;
    }

    .view-toggle button[aria-pressed="true"] {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-sm);
      transform: translateY(-1px);
    }

    .map-section {
      display: grid;
      gap: 16px;
    }

    .map-container {
      position: relative;
      min-height: clamp(320px, 60vh, 520px);
      border-radius: var(--radius-lg);
      overflow: hidden;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(124, 58, 237, 0.18);
    }

    .map-root {
      width: 100%;
      height: 100%;
    }

    .map-container .leaflet-container {
      width: 100%;
      height: 100%;
      font-family: inherit;
    }

    .map-fallback,
    .map-warning {
      background: rgba(124, 58, 237, 0.08);
      border-radius: var(--radius-md);
      padding: 14px 16px;
      color: var(--muted);
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .map-warning {
      background: rgba(245, 158, 11, 0.14);
      color: #b45309;
    }

    .map-popup {
      display: grid;
      gap: 8px;
      max-width: 240px;
    }

    .map-popup__title {
      margin: 0;
      font-size: 1rem;
      font-weight: 700;
    }

    .map-popup__address {
      margin: 0;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .map-popup__thumb {
      width: 52px;
      height: 52px;
      border-radius: 50%;
      overflow: hidden;
      border: 2px solid rgba(124, 58, 237, 0.3);
    }

    .map-popup__thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .map-popup__actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }

    .map-popup__link {
      color: var(--primary);
      font-weight: 600;
      font-size: 0.85rem;
      text-decoration: none;
    }

    .map-popup__content {
      display: grid;
      gap: 6px;
    }

    .calendar-month {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .netflix-month {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .month-row {
      background: rgba(255, 255, 255, 0.88);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(226, 232, 240, 0.9);
      padding: 18px 20px 20px;
      display: grid;
      gap: 16px;
      box-shadow: 0 10px 32px rgba(15, 23, 42, 0.08);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .month-row:hover,
    .month-row:focus-within {
      transform: translateY(-2px);
      box-shadow: 0 18px 44px rgba(15, 23, 42, 0.16);
    }

    .month-row--today {
      border-color: rgba(124, 58, 237, 0.45);
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.18);
    }

    .month-row__header {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: baseline;
      justify-content: space-between;
    }

    .month-row__title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .month-row__day {
      font-size: 1.15rem;
      font-weight: 700;
      letter-spacing: -0.01em;
    }

    .month-row__date {
      color: var(--muted);
      font-size: 0.95rem;
    }

    .month-row__badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      border-radius: 999px;
      font-size: 0.78rem;
      padding: 6px 12px;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      white-space: nowrap;
    }

    .month-row__scroller {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      padding-bottom: 4px;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
    }

    .month-row__scroller::-webkit-scrollbar {
      height: 8px;
    }

    .month-row__scroller::-webkit-scrollbar-thumb {
      background: rgba(124, 58, 237, 0.24);
      border-radius: 999px;
    }

    .show-card {
      flex: 0 0 clamp(220px, 26vw, 280px);
      display: grid;
      gap: 10px;
      background: rgba(124, 58, 237, 0.08);
      border-radius: var(--radius-md);
      padding: 12px;
      border: 1px solid rgba(124, 58, 237, 0.16);
      scroll-snap-align: start;
      box-shadow: 0 10px 28px rgba(124, 58, 237, 0.16);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .show-card:hover,
    .show-card:focus-within {
      transform: translateY(-4px);
      box-shadow: 0 16px 40px rgba(124, 58, 237, 0.22);
    }

    .show-card__thumb {
      border-radius: var(--radius-sm);
      overflow: hidden;
      background: rgba(124, 58, 237, 0.16);
      aspect-ratio: 16 / 9;
      position: relative;
    }

    .show-card__thumb-button {
      appearance: none;
      padding: 0;
      border: none;
      background: none;
      display: block;
      cursor: zoom-in;
      border-radius: var(--radius-sm);
      overflow: hidden;
      width: 100%;
    }

    .show-card__thumb-button:focus-visible {
      outline: 3px solid rgba(124, 58, 237, 0.45);
      outline-offset: 4px;
    }

    .show-card__thumb-button .show-card__thumb {
      pointer-events: none;
    }

    .show-card__thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .show-card__thumb--empty {
      display: flex;
      align-items: center;
      justify-content: center;
      color: rgba(124, 58, 237, 0.65);
      font-size: 0.75rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }

    .show-card__thumb--empty::after {
      content: "Sin imagen";
    }

    .show-card__body {
      display: grid;
      gap: 6px;
    }

    .show-card__cta {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 12px;
      background: linear-gradient(135deg, #7c3aed, #6366f1);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      text-decoration: none;
      box-shadow: 0 12px 24px rgba(124, 58, 237, 0.25);
      transition: filter 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }

    .show-card__cta:hover,
    .show-card__cta:focus-visible {
      filter: brightness(1.05);
      transform: translateY(-1px);
      box-shadow: 0 16px 32px rgba(124, 58, 237, 0.28);
      outline: none;
    }

    .show-card__title {
      margin: 0;
      font-size: 1rem;
      font-weight: 600;
      color: var(--ink);
    }

    .show-card__meta {
      display: grid;
      gap: 4px;
      font-size: 0.85rem;
      color: rgba(15, 23, 42, 0.76);
    }

    .month-row__empty {
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(248, 250, 252, 0.75);
      border-radius: var(--radius-md);
      padding: 12px;
      text-align: center;
      gap: 10px;
    }

    .month-row__cta {
      appearance: none;
      border: none;
      background: var(--primary);
      color: #fff;
      font-weight: 600;
      font-size: 0.95rem;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      text-decoration: none;
      box-shadow: var(--shadow-sm);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .month-row__cta:hover,
    .month-row__cta:focus-visible {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
      outline: none;
    }

    .month-row__summary {
      font-size: 0.9rem;
      color: rgba(16, 24, 40, 0.7);
    }

    .agenda-view {
      display: grid;
      gap: 28px;
    }

    .filters-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 12px 16px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(124, 58, 237, 0.08);
      display: grid;
      gap: 12px;
      transition: all 0.25s ease;
    }

    .filters-card.is-collapsed {
      padding-bottom: 10px;
    }

    .filters-card.is-collapsed .filters {
      display: none;
    }

    .filters-card__header {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      justify-content: space-between;
      align-items: center;
    }

    .filters-card__title {
      margin: 0;
      font-size: 1.05rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .filters-card__title span {
      display: inline-flex;
      width: 28px;
      height: 28px;
      border-radius: 10px;
      background: var(--primary-soft);
      color: var(--primary);
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .filters-card__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px 10px;
      align-items: center;
      justify-content: flex-end;
      margin-left: auto;
    }

    .filter-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
    }

    .filter-summary__count {
      font-weight: 600;
      color: var(--muted);
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .filters label {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .filters select,
    .filters input {
      padding: 6px 10px;
      border: 1px solid var(--ring);
      border-radius: 12px;
      font-size: 0.9rem;
      background: rgba(248, 250, 252, 0.9);
      transition: all 0.25s ease;
      color: var(--ink);
    }

    .filters select:focus,
    .filters input:focus {
      outline: none;
      border-color: rgba(124, 58, 237, 0.4);
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.12);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 8px;
      background: var(--primary-soft);
      color: var(--primary);
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 600;
      border: 1px solid rgba(124, 58, 237, 0.2);
    }

    .chip button {
      background: transparent;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font-size: 0.95rem;
      line-height: 1;
    }

    .filters-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(124, 58, 237, 0.18);
      background: rgba(124, 58, 237, 0.08);
      color: var(--primary);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: all 0.25s ease;
    }

    .filters-toggle:hover,
    .filters-toggle:focus-visible {
      background: rgba(124, 58, 237, 0.16);
      outline: none;
      transform: translateY(-1px);
    }

    .agenda-section {
      display: grid;
      gap: 24px;
    }

    .agenda {
      display: grid;
      gap: 20px;
    }

    .agenda__list {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 18px;
    }

    .card {
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.82);
      border-radius: var(--radius-lg);
      border: 1px solid rgba(124, 58, 237, 0.16);
      box-shadow: 0 12px 28px rgba(79, 70, 229, 0.15);
      overflow: hidden;
      min-height: 320px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .card:hover,
    .card:focus-within {
      transform: translateY(-3px);
      box-shadow: 0 20px 44px rgba(79, 70, 229, 0.22);
    }

    .thumb {
      position: relative;
      aspect-ratio: 4 / 3;
      overflow: hidden;
      background: rgba(124, 58, 237, 0.18);
      display: flex;
      align-items: center;
      justify-content: center;
      border-bottom: 1px solid rgba(124, 58, 237, 0.12);
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .thumb__overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0) 40%, rgba(15, 23, 42, 0.75) 100%);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 16px;
      pointer-events: none;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      backdrop-filter: blur(12px);
    }

    .badge--format {
      background: rgba(252, 231, 243, 0.85);
      color: #db2777;
      align-self: flex-start;
    }

    .badge--country {
      background: rgba(14, 165, 233, 0.24);
      color: #0ea5e9;
      align-self: flex-end;
    }

    .content {
      padding: 18px 18px 20px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }

    .content h3 {
      font-size: 1.2rem;
      line-height: 1.3;
      font-weight: 700;
      margin: 0;
    }

    .meta {
      color: var(--muted);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
    }

    .meta strong {
      color: var(--ink);
      font-weight: 600;
    }

    .actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      text-align: center;
      text-decoration: none;
      flex: 1;
      transition: all 0.25s ease;
    }

    .btn-primary {
      background: linear-gradient(135deg, #7c3aed, #6366f1);
      color: #fff;
      border: none;
      box-shadow: 0 12px 24px rgba(124, 58, 237, 0.25);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(245, 158, 11, 0.14);
      color: #b45309;
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .btn-secondary:hover {
      background: rgba(245, 158, 11, 0.22);
    }

    .empty-state {
      background: rgba(255, 255, 255, 0.9);
      border: 1px dashed rgba(124, 58, 237, 0.3);
      border-radius: var(--radius-lg);
      padding: 48px;
      text-align: center;
      color: var(--muted);
      display: grid;
      gap: 12px;
      grid-column: 1 / -1;
    }

    .empty-state strong {
      color: var(--primary);
      font-size: 1.1rem;
    }

    .skeleton-card {
      pointer-events: none;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(148, 163, 184, 0.08), rgba(226, 232, 240, 0.24));
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 0;
      min-height: 320px;
    }

    .skeleton-thumb {
      height: 180px;
      background: linear-gradient(90deg, rgba(226, 232, 240, 0.6), rgba(148, 163, 184, 0.4), rgba(226, 232, 240, 0.6));
      background-size: 200% 100%;
      animation: shimmer 1.8s ease-in-out infinite;
    }

    .skeleton-body {
      padding: 20px;
      display: grid;
      gap: 12px;
    }

    .skeleton-line {
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(226, 232, 240, 0.6), rgba(148, 163, 184, 0.4), rgba(226, 232, 240, 0.6));
      background-size: 200% 100%;
      animation: shimmer 1.8s ease-in-out infinite;
    }

    .skeleton-line.short {
      width: 60%;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .scale-enter-active,
    .scale-leave-active {
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .scale-enter-from,
    .scale-leave-to {
      transform: scale(0.98);
      opacity: 0;
    }

    .agenda-footer {
      background: linear-gradient(180deg, rgba(124, 58, 237, 0.08) 0%, rgba(248, 250, 252, 0.9) 100%);
      border-radius: var(--radius-lg);
      padding: 32px 24px 40px;
      display: grid;
      gap: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(124, 58, 237, 0.12);
    }

    .agenda-footer__metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
    }

    .agenda-footer__download {
      display: flex;
      justify-content: center;
    }

    .agenda-footer__button {
      max-width: 320px;
    }

    .agenda-footer__button[disabled] {
      opacity: 0.7;
      cursor: not-allowed;
    }

    @media (max-width: 900px) {
      .filters-card {
        padding: 12px 14px;
      }

      .filters-card__meta {
        width: 100%;
        justify-content: space-between;
      }
    }

    @media (max-width: 768px) {
      .filters-card__title {
        font-size: 1rem;
      }

      .filters-card__title span {
        width: 26px;
        height: 26px;
        font-size: 0.85rem;
      }

      .agenda__list {
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      }
    }

    @media (max-width: 640px) {
      .filters-card {
        padding: 12px;
      }

      .filters-card__meta {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .filter-summary {
        gap: 6px;
      }

      .filter-summary__count {
        font-size: 0.78rem;
      }

      .chip {
        padding: 4px 6px;
        font-size: 0.72rem;
      }

      .filters {
        grid-template-columns: 1fr;
      }

      .filters-toggle {
        justify-content: center;
        font-size: 0.78rem;
        padding: 6px 10px;
      }

      .filters label {
        font-size: 0.78rem;
      }

      .agenda-footer {
        padding: 24px 18px 32px;
      }
    }

    @media (max-width: 540px) {
      .agenda__list {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 14px;
      }

      .card {
        border-radius: var(--radius-md);
      }

      .content {
        padding: 14px 14px 18px;
      }

      .content h3 {
        font-size: 1.05rem;
      }

      .meta {
        font-size: 0.85rem;
      }

      .btn {
        padding: 8px 12px;
        font-size: 0.85rem;
      }
    }

    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
      color: var(--muted);
      font-size: 1rem;
    }

    .loading::before {
      content: "";
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 3px solid rgba(124, 58, 237, 0.16);
      border-top-color: var(--primary);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    @media (max-width: 960px) {
      .month-row {
        padding: 16px;
      }

      .month-row__scroller {
        gap: 12px;
      }

      .show-card {
        flex-basis: clamp(200px, 48vw, 240px);
      }

      .show-card__cta {
        padding: 8px 12px;
        font-size: 0.85rem;
      }

      .agenda-card {
        grid-template-columns: minmax(0, 1fr);
      }

      .agenda-card__thumb {
        aspect-ratio: 16 / 9;
      }
    }

    @media (max-width: 640px) {
      .calendar-card {
        padding: 16px;
      }

      .calendar-card__header {
        align-items: stretch;
      }

      .calendar-card__actions {
        flex-direction: column;
        align-items: stretch;
      }

      .calendar-controls,
      .view-toggle {
        width: 100%;
        justify-content: space-between;
      }

      .month-row {
        padding: 14px;
      }

      .month-row__header {
        align-items: flex-start;
      }

      .month-row__badge {
        margin-top: 8px;
      }

      .show-card {
        flex-basis: clamp(200px, 72vw, 260px);
      }

      .agenda-card {
        padding: 16px;
      }

      .agenda-card__footer {
        flex-direction: column;
        align-items: flex-start;
      }
    }
    .suggestion-trigger {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .suggestion-button {
      appearance: none;
      border: none;
      background: var(--primary);
      color: #ffffff;
      font-weight: 600;
      font-size: 0.9rem;
      padding: 10px 18px;
      border-radius: 999px;
      box-shadow: var(--shadow-sm);
      cursor: pointer;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .suggestion-button:focus-visible {
      outline: 3px solid rgba(124, 58, 237, 0.3);
      outline-offset: 2px;
    }

    .suggestion-button:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-md);
    }

    .suggestion-info-button {
      appearance: none;
      border: none;
      background: rgba(15, 23, 42, 0.08);
      color: var(--primary);
      font-weight: 700;
      font-size: 0.9rem;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: grid;
      place-items: center;
      cursor: pointer;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .suggestion-info-button:hover,
    .suggestion-info-button:focus-visible {
      background: rgba(124, 58, 237, 0.12);
      transform: translateY(-1px);
      outline: none;
    }

    .suggestion-info-button:focus-visible {
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.25);
    }

    .suggestion-info {
      position: fixed;
      top: 68px;
      right: 20px;
      max-width: min(280px, 80vw);
      padding: 16px 18px;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-md);
      background: #ffffff;
      color: var(--muted);
      font-size: 0.9rem;
      line-height: 1.4;
      transform-origin: top right;
      transform: scale(0.95);
      opacity: 0;
      transition: opacity 0.2s ease, transform 0.2s ease;
      pointer-events: none;
    }

    .suggestion-info.is-visible {
      opacity: 1;
      transform: scale(1);
      pointer-events: auto;
    }

    .suggestion-dialog::backdrop {
      background: rgba(15, 23, 42, 0.35);
    }

    .suggestion-dialog {
      border: none;
      border-radius: var(--radius-md);
      padding: 0;
      max-width: min(420px, 90vw);
      width: 100%;
      box-shadow: var(--shadow-md);
      background: #ffffff;
    }

    .suggestion-dialog__inner {
      padding: 24px;
      display: grid;
      gap: 16px;
    }

    .suggestion-dialog h2 {
      margin: 0;
      font-size: 1.3rem;
    }

    .suggestion-dialog p {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .suggestion-dialog textarea {
      width: 100%;
      min-height: 120px;
      padding: 12px;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(124, 58, 237, 0.3);
      resize: vertical;
      font-family: inherit;
      font-size: 0.95rem;
    }

    .suggestion-dialog textarea:focus-visible {
      outline: 2px solid rgba(124, 58, 237, 0.4);
      outline-offset: 2px;
    }

    .suggestion-dialog__actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .suggestion-dialog__actions button,
    .suggestion-dialog__actions input[type="submit"] {
      border: none;
      border-radius: 999px;
      padding: 10px 18px;
      font-weight: 600;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .suggestion-dialog__actions .cancel-button {
      background: rgba(15, 23, 42, 0.08);
      color: var(--ink);
    }

    .suggestion-dialog__actions .submit-button {
      background: var(--primary);
      color: #ffffff;
    }

    .suggestion-status {
      font-size: 0.9rem;
      min-height: 1.2em;
    }

    .suggestion-status--success {
      color: var(--success);
    }

    .suggestion-status--error {
      color: #dc2626;
    }

    .flyer-dialog::backdrop {
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(2px);
    }

    .flyer-dialog {
      border: none;
      padding: 0;
      border-radius: var(--radius-lg);
      width: min(92vw, 680px);
      max-width: 680px;
      max-height: 92vh;
      background: transparent;
    }

    .flyer-dialog__inner {
      position: relative;
      background: var(--card);
      border-radius: inherit;
      overflow: hidden;
      box-shadow: var(--shadow-md);
      display: grid;
      gap: 0;
      max-height: inherit;
    }

    .flyer-dialog__media {
      background: rgba(124, 58, 237, 0.12);
      display: block;
      max-height: calc(92vh - 120px);
      overflow: auto;
    }

    .flyer-dialog__media img {
      display: block;
      width: 100%;
      height: auto;
    }

    .flyer-dialog__info {
      padding: 18px 22px 22px;
      display: grid;
      gap: 8px;
    }

    .flyer-dialog__info h2 {
      margin: 0;
      font-size: 1.2rem;
      letter-spacing: -0.01em;
    }

    .flyer-dialog__info p {
      margin: 0;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .flyer-dialog__close {
      position: absolute;
      top: 12px;
      right: 12px;
      border: none;
      background: rgba(16, 24, 40, 0.65);
      color: #fff;
      width: 36px;
      height: 36px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 1.4rem;
      line-height: 1;
      transition: background 0.2s ease, transform 0.2s ease;
    }

    .flyer-dialog__close:hover,
    .flyer-dialog__close:focus-visible {
      background: rgba(124, 58, 237, 0.85);
      transform: scale(1.05);
      outline: none;
    }

    .visually-hidden {
      position: absolute !important;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .suggestion-counter {
      font-size: 0.85rem;
      color: var(--muted);
      text-align: right;
    }

  </style>
</head>
<body>
  <div class="suggestion-trigger">
    <button type="button" class="suggestion-button" id="suggestionButton">Tengo una idea!!!</button>
    <button
      type="button"
      class="suggestion-info-button"
      id="suggestionInfoButton"
      aria-expanded="false"
      aria-controls="suggestionInfo"
      aria-label="¬øC√≥mo usamos tus ideas?"
    >?</button>
  </div>
  <div class="suggestion-info" id="suggestionInfo" hidden>
    ¬øUn problema en la impro que te gustar√≠a resolver? Cu√©ntanoslo ‚Äî podr√≠amos convertirlo en una soluci√≥n
    abierta para todos. Leemos las ideas/problemas y ejecutamos/resolvemos las m√°s pedidas.
  </div>

  <dialog class="suggestion-dialog" id="suggestionDialog" aria-labelledby="suggestionDialogTitle">
    <form
      class="suggestion-dialog__inner"
      method="POST"
      action="https://docs.google.com/forms/d/e/1FAIpQLScCdkRzlzCz5LYI-UWOafbBLKZJ5oHd4Ah32JTmB8_TfV5PJg/formResponse"
      target="suggestionFrame"
      id="suggestionForm"
    >
      <h2 id="suggestionDialogTitle">Env√≠a tu sugerencia</h2>
      <p>Cu√©ntanos qu√© te gustar√≠a mejorar o agregar.</p>
      <label class="visually-hidden" for="suggestionTextarea">Tu sugerencia</label>
      <textarea
        id="suggestionTextarea"
        name="sugerencia-visible"
        maxlength="200"
        placeholder="Ej.: Agregar modo oscuro, filtrar por categor√≠a..."
        required
        aria-describedby="suggestionCounter"
      ></textarea>
      <input type="hidden" name="entry.1381094280" id="suggestionHidden" />
      <input type="hidden" name="fvv" value="1" />
      <input type="hidden" name="draftResponse" value="[]" />
      <input type="hidden" name="pageHistory" value="0" />
      <input type="hidden" name="fbzx" id="suggestionFbzx" />
      <label class="visually-hidden" for="suggestionHoneypot">Deja este campo vac√≠o</label>
      <input type="text" id="suggestionHoneypot" name="entry.999999999" tabindex="-1" autocomplete="off" class="visually-hidden" />
      <div class="suggestion-counter" id="suggestionCounter">0 / 200</div>
      <div class="suggestion-status" id="suggestionStatus" role="status" aria-live="polite"></div>
      <div class="suggestion-dialog__actions">
        <button type="button" class="cancel-button" id="suggestionCancel">Cancelar</button>
        <input type="submit" value="Enviar" class="submit-button" />
      </div>
    </form>
  </dialog>

  <iframe title="Env√≠o de sugerencias" name="suggestionFrame" id="suggestionFrame" class="visually-hidden"></iframe>

  <script>
    (function () {
      const button = document.getElementById('suggestionButton');
      const dialog = document.getElementById('suggestionDialog');
      const textarea = document.getElementById('suggestionTextarea');
      const hiddenInput = document.getElementById('suggestionHidden');
      const fbzxInput = document.getElementById('suggestionFbzx');
      const status = document.getElementById('suggestionStatus');
      const cancelButton = document.getElementById('suggestionCancel');
      const form = document.getElementById('suggestionForm');
      const counter = document.getElementById('suggestionCounter');
      const iframe = document.getElementById('suggestionFrame');
      const honeypot = document.getElementById('suggestionHoneypot');
      const infoButton = document.getElementById('suggestionInfoButton');
      const infoContainer = document.getElementById('suggestionInfo');
      let awaitingResponse = false;
      let timeoutId = null;
      let closeId = null;

      if (!button || !dialog) {
        return;
      }

      const generateFbzx = () => {
        if (window.crypto && typeof window.crypto.randomUUID === 'function') {
          return window.crypto.randomUUID();
        }
        return `${Math.random().toString(36).slice(2)}${Date.now().toString(36)}`;
      };

      const refreshFbzx = () => {
        if (fbzxInput) {
          fbzxInput.value = generateFbzx();
        }
      };

      const resetStatus = () => {
        status.textContent = '';
        status.className = 'suggestion-status';
      };

      const updateCounter = () => {
        const length = textarea.value.length;
        counter.textContent = `${length} / 200`;
        hiddenInput.value = textarea.value;
      };

      const hideInfo = (immediate = false) => {
        if (!infoContainer) {
          return;
        }
        const removeHidden = () => {
          infoContainer.setAttribute('hidden', '');
          infoContainer.removeEventListener('transitionend', removeHidden);
        };
        infoContainer.classList.remove('is-visible');
        if (immediate) {
          removeHidden();
          return;
        }
        if (window.getComputedStyle(infoContainer).transitionDuration === '0s') {
          removeHidden();
          return;
        }
        infoContainer.addEventListener('transitionend', removeHidden, { once: true });
      };

      const showInfo = () => {
        if (!infoContainer) {
          return;
        }
        infoContainer.removeAttribute('hidden');
        requestAnimationFrame(() => {
          infoContainer.classList.add('is-visible');
        });
      };

      if (infoButton && infoContainer) {
        infoButton.addEventListener('click', () => {
          const expanded = infoButton.getAttribute('aria-expanded') === 'true';
          if (expanded) {
            infoButton.setAttribute('aria-expanded', 'false');
            hideInfo();
          } else {
            infoButton.setAttribute('aria-expanded', 'true');
            showInfo();
          }
        });
      }

      const resetTimers = () => {
        if (timeoutId) {
          clearTimeout(timeoutId);
          timeoutId = null;
        }
        if (closeId) {
          clearTimeout(closeId);
          closeId = null;
        }
      };

      button.addEventListener('click', () => {
        form.reset();
        resetStatus();
        resetTimers();
        awaitingResponse = false;
        hiddenInput.value = '';
        refreshFbzx();
        dialog.showModal();
        requestAnimationFrame(() => textarea.focus());
        updateCounter();
        if (infoButton) {
          infoButton.setAttribute('aria-expanded', 'false');
        }
        hideInfo(true);
      });

      cancelButton.addEventListener('click', () => {
        dialog.close();
      });

      dialog.addEventListener('cancel', (event) => {
        event.preventDefault();
        dialog.close();
      });

      dialog.addEventListener('close', () => {
        awaitingResponse = false;
        resetTimers();
        resetStatus();
        form.reset();
        hiddenInput.value = '';
        if (fbzxInput) {
          fbzxInput.value = '';
        }
        updateCounter();
        button.focus();
      });

      textarea.addEventListener('input', updateCounter);

      form.addEventListener('submit', (event) => {
        if (honeypot.value) {
          event.preventDefault();
          return;
        }
        refreshFbzx();
        updateCounter();
        awaitingResponse = true;
        resetStatus();
        status.textContent = 'Enviando‚Ä¶';
        timeoutId = setTimeout(() => {
          if (awaitingResponse) {
            awaitingResponse = false;
            status.textContent = 'No pudimos enviar tu sugerencia. Int√©ntalo de nuevo.';
            status.className = 'suggestion-status suggestion-status--error';
          }
          timeoutId = null;
        }, 8000);
      });

      iframe.addEventListener('load', () => {
        if (!awaitingResponse) {
          return;
        }
        awaitingResponse = false;
        resetTimers();
        status.textContent = '¬°Gracias! Recibimos tu sugerencia.';
        status.className = 'suggestion-status suggestion-status--success';
        closeId = setTimeout(() => {
          dialog.close();
        }, 2000);
      });
    })();
  </script>

  <div id="app" class="page" v-cloak>
    <header class="hero">
      <div class="hero__inner">
      </div>
    </header>

    <main>
      <div class="wrap">
        <section class="calendar-card">
          <div class="calendar-card__header">
            <div class="calendar-card__title">
              <h2 id="calendar-title">{{ mesActualLabel }}</h2>
            </div>
            <div class="calendar-card__actions">
              <div class="calendar-controls" role="group" aria-label="Cambiar de mes">
                <button type="button" @click="cambiarMes(-1)" aria-label="Ir al mes anterior">‚Üê</button>
                <span aria-hidden="true">{{ mesActualCorto }}</span>
                <button type="button" @click="cambiarMes(1)" aria-label="Ir al mes siguiente">‚Üí</button>
              </div>
              <div class="view-toggle" role="group" aria-label="Cambiar vista del calendario">
                <button
                  type="button"
                  :aria-pressed="vista === 'month'"
                  @click="vista = 'month'"
                >Vista mensual</button>
                <button
                  type="button"
                  :aria-pressed="vista === 'agenda'"
                  @click="vista = 'agenda'"
                >Vista agenda</button>
                <button
                  type="button"
                  :aria-pressed="vista === 'map'"
                  @click="vista = 'map'"
                >Mapa</button>
              </div>
            </div>
          </div>

          <div v-if="error" class="empty">{{ error }}</div>
          <div v-else-if="cargando" class="loading">Cargando eventos‚Ä¶</div>
          <template v-else>
            <template v-if="vista === 'month'">
              <section class="filters-card" :class="{ 'is-collapsed': !filtersExpanded }">
                <header class="filters-card__header">
                  <h2 class="filters-card__title"><span>üéüÔ∏è</span> Filtrar agenda</h2>
                  <div class="filters-card__meta">
                    <div class="filter-summary">
                      <template v-for="chip in activeFilters" :key="chip.key">
                        <span class="chip">
                          {{ chip.label }}: {{ chip.value }}
                          <button type="button" @click="removeFilter(chip.key)" aria-label="Quitar filtro">&times;</button>
                        </span>
                      </template>
                    </div>
                    <button
                      type="button"
                      class="filters-toggle"
                      @click="toggleFilters"
                      :aria-expanded="filtersExpanded"
                      aria-controls="filters-panel"
                    >
                      <span aria-hidden="true">‚ñæ</span>
                      {{ filtersToggleLabel }}
                    </button>
                  </div>
                </header>
                <div class="filters" id="filters-panel" :aria-hidden="!filtersExpanded">
                  <label for="fPais">
                    Pa√≠s
                    <select id="fPais" v-model="filters.pais">
                      <option value="">Todos los pa√≠ses</option>
                      <option v-for="opt in paisOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                    </select>
                  </label>
                  <label for="fCiudad">
                    Ciudad
                    <select id="fCiudad" v-model="filters.ciudad">
                      <option value="">Todas las ciudades</option>
                      <option v-for="opt in ciudadOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                    </select>
                  </label>
                  <label for="fCompania">
                    Compa√±√≠a
                    <select id="fCompania" v-model="filters.compania">
                      <option value="">Todas las compa√±√≠as</option>
                      <option v-for="opt in companiaOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                    </select>
                  </label>
                  <label for="fFecha">
                    Fecha desde
                    <input id="fFecha" type="date" v-model="filters.fecha" :min="hoyISO" />
                  </label>
                  <label for="fSearch">
                    B√∫squeda
                    <input
                      id="fSearch"
                      type="text"
                      v-model="filters.search"
                      placeholder="Buscar por t√≠tulo, lugar o compa√±√≠a"
                    />
                  </label>
                </div>
              </section>
              <div class="calendar-month netflix-month" role="list" aria-labelledby="calendar-title">
                <!--
                  Vista mensual tipo carrusel: cada fila representa un d√≠a del mes, mantiene ancho estable para las tarjetas y usa
                  scroll horizontal con snap para minimizar saltos de dise√±o. Se reutiliza el mapa de eventos existente sin
                  alterar la fuente de datos ni dependencias adicionales. Las jornadas vac√≠as muestran un CTA para registrar
                  shows, mientras que los d√≠as con actividades mantienen foco y hover para accesibilidad. Los eventos sin flyer
                  muestran ahora un placeholder textual "Sin imagen".
                -->
                <article
                  v-for="day in diasDelMes"
                  :key="day.iso"
                  class="month-row"
                  :class="{ 'month-row--today': day.esHoy }"
                  role="listitem"
                  :aria-label="descripcionFila(day)"
                >
                <header class="month-row__header">
                  <div class="month-row__title">
                    <span class="month-row__day">{{ diaSemanaCorta(day.iso) }} ¬∑ {{ day.numero }}</span>
                    <span class="month-row__date">{{ fechaLarga(day.iso) }}</span>
                  </div>
                  <span class="month-row__badge">{{ day.eventos.length }} ¬∑ {{ day.eventos.length === 1 ? 'evento' : 'eventos' }}</span>
                </header>
                <div v-if="day.eventos.length" class="month-row__scroller" role="group" :aria-label="`Eventos del ${fechaLarga(day.iso)}`">
                  <article
                    v-for="evento in day.eventos"
                    :key="evento.id"
                    class="show-card"
                    role="group"
                    :aria-label="`Evento ${evento.nombre}`"
                  >
                    <button
                      v-if="evento.imageCandidates.length"
                      type="button"
                      class="show-card__thumb-button"
                      @click="openFlyer(evento, $event)"
                      :aria-label="`Ver flyer completo de ${evento.nombre}`"
                      aria-haspopup="dialog"
                    >
                      <span class="visually-hidden">Ver flyer completo de {{ evento.nombre }}</span>
                      <div
                        class="show-card__thumb"
                        v-img-fallback="{ sources: evento.imageCandidates, alt: `Flyer del evento ${evento.nombre}` }"
                      ></div>
                    </button>
                    <div class="show-card__thumb show-card__thumb--empty" v-else aria-hidden="true"></div>
                    <div class="show-card__body">
                      <h3 class="show-card__title">{{ evento.nombre }}</h3>
                      <div class="show-card__meta">
                        <span><strong>{{ evento.horaLabel }}</strong></span>
                        <span>{{ evento.lugarLabel }}</span>
                        <span v-if="evento.ciudadLabel">{{ evento.ciudadLabel }}</span>
                      </div>
                      <a
                        v-if="evento.boleteria"
                        class="show-card__cta"
                        :href="evento.boleteria"
                        target="_blank"
                        rel="noopener noreferrer"
                      >Comprar boletas</a>
                    </div>
                  </article>
                </div>
                <div v-else class="month-row__empty">
                  <span class="month-row__summary">No hay eventos para este d√≠a.</span>
                  <a class="month-row__cta" href="registro.html">¬øTienes un show? Reg√≠stralo</a>
                </div>
              </article>
              <p v-if="!diasDelMes.length" class="empty">No hay eventos programados para este mes.</p>
              </div>
            </template>
            <template v-else-if="vista === 'map'">
              <section class="map-section" aria-labelledby="calendar-title">
                <!-- Para nuevos shows: incluye title, address y flyerUrl. lat, lng y permalink son opcionales. -->
                <!-- Usa direcciones de Bogot√° para que se puedan geocodificar en este mapa. -->
                <div v-if="mapError" class="map-fallback" role="alert">{{ mapError }}</div>
                <div
                  v-else
                  class="map-container"
                  role="region"
                  aria-live="polite"
                  aria-label="Mapa de shows de impro en Bogot√°"
                >
                  <div ref="mapContainer" class="map-root" tabindex="0"></div>
                </div>
                <p v-if="!mapReady && !mapError" class="map-fallback" role="status">
                  Cargando mapa de shows‚Ä¶
                </p>
                <p
                  v-if="mapReady && !mapError && !bogotaEventos.length"
                  class="map-fallback"
                  role="status"
                >
                  No hay eventos de Bogot√° con ubicaci√≥n disponible en este momento.
                </p>
                <div v-if="mapWarnings.length" class="map-warning" role="status">
                  Algunos shows no pudieron ubicarse: {{ mapWarnings.join(', ') }}.
                </div>
              </section>
            </template>
            <div v-else class="agenda-view" aria-labelledby="calendar-title">
              <section class="filters-card" :class="{ 'is-collapsed': !filtersExpanded }">
                <header class="filters-card__header">
                  <h2 class="filters-card__title"><span>üéüÔ∏è</span> Filtrar agenda</h2>
                  <div class="filters-card__meta">
                    <div class="filter-summary">
                      <span class="filter-summary__count">{{ agendaResultsLabel }}</span>
                      <template v-for="chip in activeFilters" :key="chip.key">
                        <span class="chip">
                          {{ chip.label }}: {{ chip.value }}
                          <button type="button" @click="removeFilter(chip.key)" aria-label="Quitar filtro">&times;</button>
                        </span>
                      </template>
                    </div>
                    <button
                      type="button"
                      class="filters-toggle"
                      @click="toggleFilters"
                      :aria-expanded="filtersExpanded"
                      aria-controls="filters-panel"
                    >
                      <span aria-hidden="true">‚ñæ</span>
                      {{ filtersToggleLabel }}
                    </button>
                  </div>
                </header>
                <div class="filters" id="filters-panel" :aria-hidden="!filtersExpanded">
                  <label for="fPais">
                    Pa√≠s
                    <select id="fPais" v-model="filters.pais">
                      <option value="">Todos los pa√≠ses</option>
                      <option v-for="opt in paisOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                    </select>
                  </label>
                  <label for="fCiudad">
                    Ciudad
                    <select id="fCiudad" v-model="filters.ciudad">
                      <option value="">Todas las ciudades</option>
                      <option v-for="opt in ciudadOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                    </select>
                  </label>
                  <label for="fCompania">
                    Compa√±√≠a
                    <select id="fCompania" v-model="filters.compania">
                      <option value="">Todas las compa√±√≠as</option>
                      <option v-for="opt in companiaOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
                    </select>
                  </label>
                  <label for="fFecha">
                    Fecha desde
                    <input id="fFecha" type="date" v-model="filters.fecha" :min="hoyISO" />
                  </label>
                  <label for="fSearch">
                    B√∫squeda
                    <input
                      id="fSearch"
                      type="text"
                      v-model="filters.search"
                      placeholder="Buscar por t√≠tulo, lugar o compa√±√≠a"
                    />
                  </label>
                </div>
              </section>
              <section class="agenda-section">
                <div class="agenda" id="agenda" role="region" aria-live="polite">
                  <template v-if="cargando">
                    <article v-for="n in 6" :key="`skeleton-${n}`" class="skeleton-card">
                      <div class="skeleton-thumb"></div>
                      <div class="skeleton-body">
                        <span class="skeleton-line"></span>
                        <span class="skeleton-line"></span>
                        <span class="skeleton-line short"></span>
                      </div>
                    </article>
                  </template>
                  <template v-else>
                    <transition-group name="scale" tag="div" class="agenda__list">
                      <article v-for="event in agendaEventosFiltrados" :key="event.id" class="card">
                        <div class="thumb" v-img-fallback="event.piezaCands">
                          <div class="thumb__overlay">
                            <span class="badge badge--format" v-if="event.formato">{{ event.formato }}</span>
                            <span class="badge badge--country" v-if="event.pais">{{ event.pais }}</span>
                          </div>
                        </div>
                        <div class="content">
                          <h3>{{ event.nombre }}</h3>
                          <p class="meta">
                            <strong>Fecha</strong>
                            <span>{{ event.fechaLabel || 'Por confirmar' }}</span>
                          </p>
                          <p class="meta">
                            <strong>Hora</strong>
                            <span>{{ event.horaLabel || 'Por definir' }}</span>
                          </p>
                          <p class="meta">
                            <strong>Lugar</strong>
                            <span>{{ event.lugarLabel || 'Pronto' }}</span>
                          </p>
                          <div class="actions" v-if="event.boleteria">
                            <a
                              :href="event.boleteria"
                              target="_blank"
                              rel="noopener"
                              class="btn btn-primary"
                            >Comprar boletas</a>
                          </div>
                        </div>
                      </article>
                    </transition-group>
                    <div v-if="!agendaEventosFiltrados.length" class="empty-state">
                      <strong>No encontramos eventos con esos filtros.</strong>
                      <span>Prueba ajustando la b√∫squeda o borra los filtros activos para ver toda la programaci√≥n.</span>
                    </div>
                  </template>
                </div>
              </section>
              <section class="agenda-footer">
                 <div class="hero__meta">
          <span><strong>{{ totalEventos }}</strong> eventos publicados</span>
          <span>Actualizado el <strong>{{ ultimaActualizacion }}</strong></span>
          <span>Pa√≠ses representados <strong>{{ totalPaisesAgenda }}</strong></span>
        </div>
                <div class="agenda-footer__download">
                  <button
                    type="button"
                    class="btn btn-secondary agenda-footer__button"
                    @click="downloadAgendaPdf"
                    :disabled="downloadingAgendaPdf || cargando"
                  >
                    {{ downloadingAgendaPdf ? 'Generando PDF‚Ä¶' : 'Descargar PDF' }}
                  </button>
                </div>
              </section>
            </div>
          </template>
        </section>
      </div>
    </main>
    <dialog
      class="flyer-dialog"
      ref="flyerDialog"
      @cancel.prevent="closeFlyer"
      @click.self="closeFlyer"
      aria-labelledby="flyerDialogTitle"
    >
      <div class="flyer-dialog__inner" role="document">
        <button type="button" class="flyer-dialog__close" @click="closeFlyer" aria-label="Cerrar flyer">&times;</button>
        <div
          class="flyer-dialog__media"
          v-if="flyerDialogData.candidates.length"
          v-img-fallback="{ sources: flyerDialogData.candidates, alt: flyerDialogData.alt }"
        ></div>
        <div class="flyer-dialog__info">
          <h2 id="flyerDialogTitle">{{ flyerDialogData.title }}</h2>
          <p v-if="flyerDialogData.meta">{{ flyerDialogData.meta }}</p>
        </div>
      </div>
    </dialog>
  </div>

  <script
    src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"
    integrity="sha512-YcsIPbRS8WwtK+iMfGqvXHl5abZEWSIk2s9InMpqA0PXI5maomCvfJqMG9XNDnsKDH4uZ8j2TPp7T2E/pPhf0g=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  ></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <script>
  const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwoCLUfEiRjnmzumQ-Qs82vLUMpfTWHuemY8W6NODHVhGskbdQQHh-rIHKJUpS0cPCSxQ/exec";
  const PLACEHOLDER_IMAGE =
    "data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHZpZXdCb3g9JzAgMCA4MDAgNDUwJz4KPHJlY3QgZmlsbD0nI2VkZTlmZScgd2lkdGg9JzgwMCcgaGVpZ2h0PSc0NTAnLz4KPHRleHQgeD0nNTAlJyB5PSc1MCUnIGZpbGw9JyM3YzNhZWQnIGZvbnQtZmFtaWx5PSdJbnRlciwgQXJpYWwsIHNhbnMtc2VyaWYnIGZvbnQtc2l6ZT0nNDgnIHRleHQtYW5jaG9yPSdtaWRkbGUnIGRvbWluYW50LWJhc2VsaW5lPSdtaWRkbGUnPlNpbiBpbWFnZW48L3RleHQ+Cjwvc3ZnPg==";

  const BOGOTA_COORDS = { lat: 4.711, lng: -74.0721 };
  const GEOCODE_STORAGE_PREFIX = "agenda-geocode:";
  const GEOCODE_INTERVAL = 1000;

  function val(x) {
    return x === undefined || x === null ? "" : String(x).trim();
  }

  function normalizeText(t) {
    return t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";
  }

  function sanitizeAddressPart(value) {
    const raw = val(value);
    if (!raw) return "";
    const replacements = [
      [/\bCra\.?\b/gi, "Carrera"],
      [/\bCr\.?\b/gi, "Carrera"],
      [/\bCrr\.?\b/gi, "Carrera"],
      [/\bCl\.?\b/gi, "Calle"],
      [/\bCll\.?\b/gi, "Calle"],
      [/\bAv\.?\b/gi, "Avenida"],
      [/\bTv\.?\b/gi, "Transversal"],
      [/\bTrv\.?\b/gi, "Transversal"],
      [/\bTrans\.?\b/gi, "Transversal"],
      [/\bDiag\.?\b/gi, "Diagonal"],
      [/\bDg\.?\b/gi, "Diagonal"],
      [/\bAk\.?\b/gi, "Avenida"],
      [/\bNo\.?\s*/gi, "# "],
    ];
    let clean = raw.replace(/[()]/g, " ");
    for (const [pattern, replacement] of replacements) {
      clean = clean.replace(pattern, replacement);
    }
    clean = clean
      .replace(/\s*#\s*/g, " #")
      .replace(/\s+-\s+/g, " - ")
      .replace(/\s*,\s*/g, ", ")
      .replace(/\s+/g, " ")
      .trim();
    return clean;
  }

  function formatIsoDate(v) {
    if (!v) return "";
    const d = new Date(v);
    if (isNaN(d)) return "";
    return d.toISOString().split("T")[0];
  }

  function escapeHtml(value) {
    return String(value || "")
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }

  const monthFormatterCache = new Map();

  function formatWithCapitalizedMonth(date, options) {
    if (!(date instanceof Date) || Number.isNaN(date.getTime())) {
      return "";
    }
    const key = JSON.stringify(
      Object.keys(options || {})
        .sort()
        .map((prop) => [prop, options[prop]])
    );
    let formatter = monthFormatterCache.get(key);
    if (!formatter) {
      formatter = new Intl.DateTimeFormat("es-ES", options);
      monthFormatterCache.set(key, formatter);
    }
    return formatter
      .formatToParts(date)
      .map((part) => {
        if (part.type === "month") {
          return part.value ? part.value.charAt(0).toUpperCase() + part.value.slice(1) : part.value;
        }
        return part.value;
      })
      .join("");
  }

  function createFallbackId() {
    try {
      if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
        return crypto.randomUUID();
      }
    } catch (_) {
      // ignore
    }
    return `event-${Date.now()}-${Math.random().toString(16).slice(2)}`;
  }

  function parseHora(value) {
    if (!value) return { label: "Horario por confirmar", minutes: Number.POSITIVE_INFINITY };
    const clean = String(value).trim();
    const match = clean.match(/(\d{1,2})(?::(\d{2}))?/);
    if (!match) {
      return { label: clean, minutes: Number.POSITIVE_INFINITY };
    }
    const hours = Number.parseInt(match[1], 10);
    const minutes = Number.parseInt(match[2] ?? "0", 10);
    if (Number.isNaN(hours) || Number.isNaN(minutes)) {
      return { label: clean, minutes: Number.POSITIVE_INFINITY };
    }
    const label = `${hours.toString().padStart(2, "0")}:${minutes.toString().padStart(2, "0")}`;
    return { label, minutes: hours * 60 + minutes };
  }

  function extractDriveId(u) {
    if (!u) return "";
    let match;
    if ((match = String(u).match(/[?&]id=([-\w]+)/))) return match[1];
    if ((match = String(u).match(/\/d\/([-\w]+)/))) return match[1];
    return "";
  }

  function driveImageCandidates(u) {
    const id = extractDriveId(u);
    if (!id) {
      return u ? [u] : [];
    }
    return [
      `https://drive.google.com/uc?export=view&id=${id}`,
      `https://drive.google.com/thumbnail?id=${id}&sz=w1200`,
      `https://lh3.googleusercontent.com/d/${id}=w1200`,
    ];
  }

  function uniqueNonEmpty(list) {
    const set = new Set();
    const result = [];
    for (const item of list) {
      const value = val(item);
      if (!value || set.has(value)) continue;
      set.add(value);
      result.push(value);
    }
    return result;
  }

  function buildImageCandidates(ev) {
    const directFlyers = [
      ev.FlyerURL,
      ev.Flyer,
      ev.FlyerWeb,
      ev.Poster,
      ev.Imagen,
      ev.ImagenFlyer,
      ev.ImagenEvento,
      ev.ImagenDestacada,
    ];
    const promotional = [
      ...driveImageCandidates(val(ev.PiezaPromocional)),
      ...driveImageCandidates(val(ev.PiezaPromo)),
      ...driveImageCandidates(val(ev.ImagenPromocional)),
    ];
    return uniqueNonEmpty([...promotional, ...directFlyers]);
  }

  function resolveImageConfig(value) {
    if (!value) return { sources: [], alt: "" };
    if (Array.isArray(value)) return { sources: value, alt: "" };
    if (typeof value === "string") return { sources: [value], alt: "" };
    if (typeof value === "object") {
      const src = Array.isArray(value.sources)
        ? value.sources
        : Array.isArray(value.candidates)
        ? value.candidates
        : [];
      return {
        sources: src,
        alt: val(value.alt || value.altText),
      };
    }
    return { sources: [], alt: "" };
  }

  function createImgWithFallback(config) {
    const { sources, alt } = config;
    const candidates = Array.isArray(sources) ? sources : [];
    const img = document.createElement("img");
    img.loading = "lazy";
    img.decoding = "async";
    if (alt) img.alt = alt;
    let index = 0;

    const tryNext = () => {
      if (index >= candidates.length) {
        img.onerror = null;
        img.src = PLACEHOLDER_IMAGE;
        return;
      }
      img.src = candidates[index];
      index += 1;
    };

    img.addEventListener("error", tryNext);
    img.addEventListener("load", () => {
      img.onerror = null;
    });

    tryNext();
    return img;
  }

  function mountImageWithFallback(el, value) {
    const config = resolveImageConfig(value);
    el.innerHTML = "";
    el.appendChild(createImgWithFallback(config));
  }

  function norm(ev) {
    const id = val(ev.Id) || val(ev.ID) || createFallbackId();
    const nombre = val(ev.NombreFormato) || val(ev["Nombre de la Obra"]) || "Evento sin nombre";
    const formato =
      val(ev.Formato) ||
      val(ev.FormatoObra) ||
      val(ev["Formato de la Obra"]) ||
      val(ev.TipoFormato) ||
      "";
    const fechaRaw = ev.FechaFuncion || ev.fecha || ev.fechaRaw || "";
    const fechaISO = formatIsoDate(fechaRaw);
    let fechaLabel = "";
    let fechaTime = null;
    if (fechaRaw) {
      const d = new Date(fechaRaw);
      if (!Number.isNaN(d.getTime())) {
        fechaLabel = formatWithCapitalizedMonth(d, { day: "numeric", month: "short", year: "numeric" });
        const local = new Date(d);
        local.setHours(0, 0, 0, 0);
        fechaTime = local.getTime();
      }
    }
    const horaTexto = val(ev.HoraFuncionTexto) || val(ev.HoraFuncion);
    const horaInfo = parseHora(horaTexto);
    const pais = val(ev.Pais) || val(ev["Pa√≠s"]);
    const ciudad = val(ev.Ciudad);
    const lugar = val(ev.Lugar);
    const compania = val(ev.Compania) || val(ev["Compa√±√≠a"]);
    const descripcion = val(ev.Descripcion) || val(ev.Descripci√≥n) || "";
    const direccion =
      val(ev.Direccion) ||
      val(ev["Direcci√≥n"]) ||
      val(ev.DireccionLugar) ||
      val(ev.DireccionEvento) ||
      val(ev.Address) ||
      val(ev.Ubicacion) ||
      val(ev["Ubicaci√≥n"]) ||
      "";
    const permalink =
      val(ev.Permalink) ||
      val(ev.URL) ||
      val(ev.Link) ||
      val(ev.LinkEvento) ||
      val(ev["Link evento"]) ||
      val(ev.Enlace) ||
      "";
    const rawLat =
      ev.Latitud ??
      ev.latitud ??
      ev.lat ??
      ev.Latitude ??
      (ev.latLng && (ev.latLng.lat ?? ev.latLng.Lat));
    const rawLng =
      ev.Longitud ??
      ev.longitud ??
      ev.lng ??
      ev.Lng ??
      ev.Longitude ??
      (ev.latLng && (ev.latLng.lng ?? ev.latLng.Lng));
    const parsedLat = Number.parseFloat(rawLat);
    const parsedLng = Number.parseFloat(rawLng);
    const lat = Number.isFinite(parsedLat) ? parsedLat : null;
    const lng = Number.isFinite(parsedLng) ? parsedLng : null;
    const imageCandidates = buildImageCandidates(ev);
    const promoCandidates = driveImageCandidates(val(ev.PiezaPromocional));
    const piezaCands = promoCandidates.length ? promoCandidates : imageCandidates;
    const boleteria =
      val(ev.Boleteria) ||
      val(ev.LinkBoleteria) ||
      val(ev["Link Boleteria"]) ||
      val(ev["Link boletos"]) ||
      "";
    const estado = val(ev.Estado) || "Publicado";

    const searchText = normalizeText(
      [
        nombre,
        formato,
        fechaLabel,
        horaTexto,
        pais,
        ciudad,
        lugar,
        compania,
        val(ev.Director),
        val(ev.Sinopsis),
        descripcion,
        direccion,
      ].join(" ")
    );

    return {
      id,
      nombre,
      formato,
      fechaRaw,
      fechaISO,
      fechaLabel,
      fechaTime,
      hora: horaTexto,
      horaLabel: horaInfo.label,
      horaValue: horaInfo.minutes,
      pais,
      ciudad,
      ciudadLabel: ciudad || pais || "",
      lugar,
      lugarLabel: lugar || "Ubicaci√≥n por confirmar",
      compania,
      boleteria,
      descripcion,
      estado,
      flyerUrl: imageCandidates[0] || "",
      imageCandidates,
      piezaCands,
      searchText,
      direccion,
      permalink,
      lat,
      lng,
    };
  }

  const { createApp, ref, reactive, computed, onMounted, watch, onBeforeUnmount, nextTick } = Vue;

  createApp({
    setup() {
      const cargando = ref(true);
      const error = ref("");
      const lista = ref([]);
      const hoy = new Date();
      const hoyISO = new Date(hoy.getTime() - hoy.getTimezoneOffset() * 60000).toISOString().split("T")[0];
      const hoySinHora = new Date(hoy.getTime());
      hoySinHora.setHours(0, 0, 0, 0);
      const hoyTimestamp = hoySinHora.getTime();
      const mesActual = ref(new Date(hoy.getFullYear(), hoy.getMonth(), 1));
      const ultimaActualizacion = ref(new Date().toLocaleDateString("es-ES", { dateStyle: "long" }));
      const vista = ref("month");

      const filters = reactive({
        search: "",
        pais: "",
        ciudad: "",
        compania: "",
        fecha: hoyISO,
      });
      const filtersExpanded = ref(false);
      const downloadingAgendaPdf = ref(false);
      const detectedCountry = ref("");
      const flyerDialog = ref(null);
      const flyerDialogData = reactive({ title: "", alt: "", meta: "", candidates: [] });
      let lastFlyerTrigger = null;
      const mapContainer = ref(null);
      const mapReady = ref(false);
      const mapError = ref("");
      const mapWarnings = ref([]);
      const eventLocations = reactive({});
      const mapWarningEntries = new Map();
      let mapInstance = null;
      let mapMarkersLayer = null;
      const geocodeQueue = [];
      let geocodeProcessing = false;
      let lastGeocodeTime = 0;
      const geocodeFailedAddresses = new Set();

      const resetFlyerDialog = () => {
        flyerDialogData.title = "";
        flyerDialogData.alt = "";
        flyerDialogData.meta = "";
        flyerDialogData.candidates = [];
      };

      const handleFlyerDialogClose = () => {
        resetFlyerDialog();
        if (lastFlyerTrigger && typeof lastFlyerTrigger.focus === "function") {
          lastFlyerTrigger.focus();
        }
        lastFlyerTrigger = null;
      };

      const closeFlyer = () => {
        const dialogEl = flyerDialog.value;
        if (!dialogEl) return;
        if (typeof dialogEl.close === "function" && dialogEl.open) {
          dialogEl.close();
        } else {
          dialogEl.removeAttribute("open");
          handleFlyerDialogClose();
        }
      };

      const openFlyer = (evento, nativeEvent) => {
        if (!evento || !Array.isArray(evento.imageCandidates) || !evento.imageCandidates.length) {
          return;
        }
        const name = evento.nombre && String(evento.nombre).trim() ? String(evento.nombre).trim() : "Evento sin nombre";
        flyerDialogData.title = name;
        flyerDialogData.alt = `Flyer del evento ${name}`;
        const details = [evento.fechaLabel, evento.horaLabel, evento.lugarLabel]
          .map((part) => (part ? String(part).trim() : ""))
          .filter(Boolean);
        flyerDialogData.meta = details.join(" ¬∑ ");
        flyerDialogData.candidates = evento.imageCandidates.slice(0, 8);
        const dialogEl = flyerDialog.value;
        if (!dialogEl) {
          return;
        }
        lastFlyerTrigger =
          nativeEvent && nativeEvent.currentTarget instanceof HTMLElement ? nativeEvent.currentTarget : null;
        if (typeof dialogEl.showModal === "function") {
          dialogEl.showModal();
        } else {
          dialogEl.setAttribute("open", "");
        }
      };

      const eventosPublicados = computed(() => lista.value.filter((ev) => ev.estado !== "Despublicado"));

      const bogotaEventos = computed(() =>
        eventosPublicados.value.filter((ev) => {
          const city = normalizeText(ev.ciudad);
          const address = normalizeText(ev.direccion || ev.lugar || ev.lugarLabel);
          return city.includes("bogota") || address.includes("bogota");
        })
      );

      const syncMapWarnings = () => {
        mapWarnings.value = Array.from(mapWarningEntries.values());
      };

      const setMapWarning = (key, message) => {
        if (message) {
          mapWarningEntries.set(key, message);
        } else {
          mapWarningEntries.delete(key);
        }
        syncMapWarnings();
      };

      const hasValidCoords = (lat, lng) => Number.isFinite(lat) && Number.isFinite(lng);

      const geocodeCacheKey = (address) => `${GEOCODE_STORAGE_PREFIX}${address}`;

      const readGeocodeCache = (address) => {
        if (!address || typeof localStorage === "undefined") return null;
        try {
          const raw = localStorage.getItem(geocodeCacheKey(address));
          if (!raw) return null;
          const parsed = JSON.parse(raw);
          const lat = Number(parsed.lat);
          const lng = Number(parsed.lng);
          if (hasValidCoords(lat, lng)) {
            return { lat, lng };
          }
        } catch (err) {
          console.warn("No se pudo leer la cach√© de geocodificaci√≥n", err);
        }
        return null;
      };

      const writeGeocodeCache = (address, coords) => {
        if (!address || typeof localStorage === "undefined") return;
        try {
          localStorage.setItem(
            geocodeCacheKey(address),
            JSON.stringify({ lat: coords.lat, lng: coords.lng })
          );
        } catch (err) {
          console.warn("No se pudo guardar la cach√© de geocodificaci√≥n", err);
        }
      };

      const buildEventAddressParts = (ev) => {
        const parts = [];
        const seen = new Set();
        const placeholder = normalizeText("Ubicaci√≥n por confirmar");
        const sameValue = (a, b) => normalizeText(val(a)) === normalizeText(val(b));
        const pushPart = (value) => {
          const clean = sanitizeAddressPart(value);
          if (!clean) return;
          const normalized = normalizeText(clean);
          if (!normalized || normalized === placeholder || seen.has(normalized)) return;
          seen.add(normalized);
          parts.push(clean);
        };

        pushPart(ev.lugar);
        pushPart(ev.direccion);
        if (!sameValue(ev.lugarLabel, ev.lugar)) {
          pushPart(ev.lugarLabel);
        }

        if (!parts.length) {
          return [];
        }

        pushPart(ev.ciudad);
        pushPart(ev.pais);

        return parts;
      };

      const getEventAddress = (ev) => buildEventAddressParts(ev).join(", ");

      const geocodeAddress = async (address) => {
        const cleanAddress = sanitizeAddressPart(address);
        const parts = [];
        if (cleanAddress) {
          parts.push(cleanAddress);
        }
        const normalized = normalizeText(cleanAddress);
        if (!normalized.includes("bogota")) {
          parts.push("Bogot√°");
        }
        if (!normalized.includes("colombia")) {
          parts.push("Colombia");
        }
        const query = parts.join(", ");
        const url = `https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(
          query
        )}`;
        const response = await fetch(url, {
          headers: {
            "Accept-Language": "es",
          },
        });
        if (!response.ok) {
          return null;
        }
        const results = await response.json();
        if (!Array.isArray(results) || !results.length) {
          return null;
        }
        const first = results[0];
        const lat = Number.parseFloat(first.lat);
        const lng = Number.parseFloat(first.lon);
        if (!hasValidCoords(lat, lng)) {
          return null;
        }
        return { lat, lng };
      };

      const ensureMap = () => {
        if (mapError.value) return;
        const container = mapContainer.value;
        if (!container) {
          mapError.value = "No encontramos el contenedor del mapa.";
          return;
        }
        if (typeof L === "undefined") {
          mapError.value = "No pudimos cargar Leaflet. Revisa tu conexi√≥n.";
          return;
        }
        if (!mapInstance) {
          try {
            mapInstance = L.map(container, { scrollWheelZoom: true, keyboard: true });
            L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
              maxZoom: 19,
              attribution:
                '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
            }).addTo(mapInstance);
            mapMarkersLayer = L.layerGroup().addTo(mapInstance);
            mapInstance.setView([BOGOTA_COORDS.lat, BOGOTA_COORDS.lng], 12);
            mapReady.value = true;
          } catch (err) {
            console.error("No fue posible inicializar el mapa", err);
            mapError.value = "No fue posible inicializar el mapa en este navegador.";
          }
        } else {
          mapReady.value = true;
          mapInstance.invalidateSize();
        }
      };

      const updateMapMarkers = () => {
        if (!mapInstance || !mapMarkersLayer) return;
        mapMarkersLayer.clearLayers();
        const boundsPoints = [];
        for (const ev of bogotaEventos.value) {
          const coords = eventLocations[ev.id];
          if (!coords || !hasValidCoords(coords.lat, coords.lng)) {
            continue;
          }
          const marker = L.marker([coords.lat, coords.lng], { keyboard: true, title: ev.nombre });
          const title = escapeHtml(ev.nombre);
          const address = escapeHtml(getEventAddress(ev) || "Direcci√≥n por confirmar");
          const imageSrc = escapeHtml(ev.flyerUrl || PLACEHOLDER_IMAGE);
          const altText = escapeHtml(`Flyer de ${ev.nombre}`);
          const permalink = val(ev.permalink);
          const linkHtml = permalink
            ? `<div class="map-popup__actions"><a class="map-popup__link" href="${escapeHtml(
                permalink
              )}" target="_blank" rel="noopener">Ver m√°s</a></div>`
            : "";
          const popupHtml = `
            <div class="map-popup">
              <div class="map-popup__thumb"><img src="${imageSrc}" alt="${altText}" loading="lazy" decoding="async" /></div>
              <div class="map-popup__content">
                <h3 class="map-popup__title">${title}</h3>
                <p class="map-popup__address">${address}</p>
                ${linkHtml}
              </div>
            </div>
          `;
          marker.bindPopup(popupHtml, { maxWidth: 260, closeButton: true });
          marker.on("add", () => {
            const el = marker.getElement();
            if (el) {
              el.setAttribute("tabindex", "0");
              el.setAttribute("role", "button");
              el.setAttribute("aria-label", `Ver detalles de ${ev.nombre}`);
            }
          });
          mapMarkersLayer.addLayer(marker);
          boundsPoints.push(marker.getLatLng());
        }
        if (boundsPoints.length) {
          const bounds = L.latLngBounds(boundsPoints);
          mapInstance.fitBounds(bounds, { padding: [32, 32] });
        } else {
          mapInstance.setView([BOGOTA_COORDS.lat, BOGOTA_COORDS.lng], 12);
        }
      };

      const processGeocodeQueue = () => {
        if (geocodeProcessing) return;
        if (vista.value !== "map") return;
        if (!geocodeQueue.length) return;
        geocodeProcessing = true;
        const now = Date.now();
        const delay = Math.max(0, GEOCODE_INTERVAL - (now - lastGeocodeTime));
        setTimeout(async () => {
          const item = geocodeQueue.shift();
          if (!item) {
            geocodeProcessing = false;
            return;
          }
          try {
            const coords = await geocodeAddress(item.address);
            if (coords && hasValidCoords(coords.lat, coords.lng)) {
              eventLocations[item.eventId] = coords;
              writeGeocodeCache(item.address, coords);
              geocodeFailedAddresses.delete(item.address);
              setMapWarning(`geocode:${item.address}`, null);
            } else {
              geocodeFailedAddresses.add(item.address);
              setMapWarning(`geocode:${item.address}`, item.label);
              console.warn(`No se pudo geocodificar la direcci√≥n: ${item.address}`);
            }
          } catch (err) {
            geocodeFailedAddresses.add(item.address);
            setMapWarning(`geocode:${item.address}`, item.label);
            console.warn(`No se pudo geocodificar la direcci√≥n: ${item.address}`, err);
          } finally {
            lastGeocodeTime = Date.now();
            geocodeProcessing = false;
            updateMapMarkers();
            processGeocodeQueue();
          }
        }, delay);
      };

      const prepareMapLocations = () => {
        const events = bogotaEventos.value;
        const activeIds = new Set(events.map((ev) => ev.id));
        const activeAddresses = new Set(events.map((ev) => getEventAddress(ev)).filter(Boolean));
        const staleWarningKeys = [];
        for (const key of mapWarningEntries.keys()) {
          if (key.startsWith("address:")) {
            const id = key.slice("address:".length);
            if (!activeIds.has(id)) {
              staleWarningKeys.push(key);
            }
          } else if (key.startsWith("geocode:")) {
            const address = key.slice("geocode:".length);
            if (address && !activeAddresses.has(address)) {
              staleWarningKeys.push(key);
            }
          }
        }
        for (const key of staleWarningKeys) {
          mapWarningEntries.delete(key);
        }
        syncMapWarnings();
        for (const address of Array.from(geocodeFailedAddresses)) {
          if (!activeAddresses.has(address)) {
            geocodeFailedAddresses.delete(address);
          }
        }
        for (const key of Object.keys(eventLocations)) {
          if (!activeIds.has(key)) {
            delete eventLocations[key];
          }
        }
        for (const ev of events) {
          const stored = eventLocations[ev.id];
          if (stored && hasValidCoords(stored.lat, stored.lng)) {
            continue;
          }
          if (hasValidCoords(ev.lat, ev.lng)) {
            eventLocations[ev.id] = { lat: ev.lat, lng: ev.lng };
            setMapWarning(`address:${ev.id}`, null);
            continue;
          }
          const address = getEventAddress(ev);
          if (!address) {
            setMapWarning(`address:${ev.id}`, `${ev.nombre} (sin direcci√≥n)`);
            continue;
          }
          setMapWarning(`address:${ev.id}`, null);
          const cached = readGeocodeCache(address);
          if (cached && hasValidCoords(cached.lat, cached.lng)) {
            eventLocations[ev.id] = cached;
            setMapWarning(`geocode:${address}`, null);
            continue;
          }
          if (geocodeFailedAddresses.has(address)) {
            setMapWarning(`geocode:${address}`, `${ev.nombre} (${address})`);
            continue;
          }
          if (!geocodeQueue.some((item) => item.eventId === ev.id)) {
            geocodeQueue.push({ eventId: ev.id, address, label: `${ev.nombre} (${address})` });
          }
        }
        if (vista.value === "map") {
          processGeocodeQueue();
        }
      };

      const eventosFiltrados = computed(() => {
        const q = normalizeText(filters.search);
        const p = filters.pais;
        const c = filters.ciudad;
        const co = filters.compania;
        const f = filters.fecha;

        return eventosPublicados.value.filter((ev) => {
          const okQ = !q || ev.searchText.includes(q);
          const okP = !p || normalizeText(ev.pais) === p;
          const okC = !c || normalizeText(ev.ciudad) === c;
          const okCo = !co || normalizeText(ev.compania) === co;
          const okF = !f || (ev.fechaISO && ev.fechaISO >= f);
          return okQ && okP && okC && okCo && okF;
        });
      });

      const eventosPorDia = computed(() => {
        const map = new Map();
        for (const item of eventosFiltrados.value) {
          if (!item.fechaISO) continue;
          if (!map.has(item.fechaISO)) {
            map.set(item.fechaISO, []);
          }
          map.get(item.fechaISO).push(item);
        }
        for (const events of map.values()) {
          events.sort((a, b) => a.horaValue - b.horaValue || a.nombre.localeCompare(b.nombre, "es"));
        }
        return map;
      });

      const totalEventos = computed(() => eventosPublicados.value.length);

      const dias = computed(() => {
        const base = new Date(mesActual.value.getTime());
        base.setDate(1);
        const offset = (base.getDay() + 6) % 7; // Monday as first day
        const inicio = new Date(base.getTime());
        inicio.setDate(inicio.getDate() - offset);
        const celdas = [];
        for (let i = 0; i < 42; i += 1) {
          const d = new Date(inicio.getTime());
          d.setDate(inicio.getDate() + i);
          const iso = new Date(d.getTime() - d.getTimezoneOffset() * 60000).toISOString().split("T")[0];
          const fechaLocal = new Date(`${iso}T00:00:00`);
          const weekdayLongRaw = fechaLocal.toLocaleDateString("es-ES", { weekday: "long" });
          const weekdayShortRaw = fechaLocal.toLocaleDateString("es-ES", { weekday: "short" });
          const monthLabel = formatWithCapitalizedMonth(fechaLocal, { day: "numeric", month: "long" });
          const eventos = eventosPorDia.value.get(iso) || [];
          celdas.push({
            iso,
            numero: d.getDate(),
            mesActual: d.getMonth() === mesActual.value.getMonth(),
            esHoy: iso === hoyISO,
            eventos,
            weekdayLong: weekdayLongRaw.charAt(0).toUpperCase() + weekdayLongRaw.slice(1),
            weekdayShort: weekdayShortRaw.charAt(0).toUpperCase() + weekdayShortRaw.slice(1),
            fechaLabel: monthLabel,
          });
        }
        return celdas;
      });

      const diasDelMes = computed(() =>
        dias.value.filter((day) => {
          if (!day.mesActual) return false;
          const dayDate = new Date(`${day.iso}T00:00:00`);
          dayDate.setHours(0, 0, 0, 0);
          return dayDate.getTime() >= hoyTimestamp;
        })
      );

      const mesActualLabel = computed(() =>
        formatWithCapitalizedMonth(mesActual.value, { month: "long", year: "numeric" })
      );

      const mesActualCorto = computed(() =>
        formatWithCapitalizedMonth(mesActual.value, { month: "short", year: "numeric" })
      );

      function cambiarMes(delta) {
        const nuevo = new Date(mesActual.value.getTime());
        nuevo.setMonth(nuevo.getMonth() + delta, 1);
        mesActual.value = nuevo;
      }

      function fechaLarga(iso) {
        const fecha = new Date(`${iso}T00:00:00`);
        const baseRaw = formatWithCapitalizedMonth(fecha, {
          weekday: "long",
          day: "numeric",
          month: "long",
        });
        return baseRaw.charAt(0).toUpperCase() + baseRaw.slice(1);
      }

      function diaSemanaCorta(iso) {
        const fecha = new Date(`${iso}T00:00:00`);
        const raw = fecha.toLocaleDateString("es-ES", { weekday: "short" });
        return raw.charAt(0).toUpperCase() + raw.slice(1);
      }

      function descripcionFila(day) {
        const base = fechaLarga(day.iso);
        if (!day.eventos.length) {
          return `${base}. Sin eventos.`;
        }
        const cantidad = day.eventos.length === 1 ? "Un evento" : `${day.eventos.length} eventos`;
        return `${base}. ${cantidad}.`;
      }

      const toggleFilters = () => {
        filtersExpanded.value = !filtersExpanded.value;
      };

      const filtersToggleLabel = computed(() =>
        filtersExpanded.value ? "Ocultar filtros" : "Mostrar filtros"
      );

      const optionFromMap = (items) => {
        const map = new Map();
        items.forEach((label) => {
          if (!label) return;
          const value = normalizeText(label);
          if (!map.has(value)) {
            map.set(value, label);
          }
        });
        return Array.from(map.entries())
          .map(([value, label]) => ({ value, label }))
          .sort((a, b) => a.label.localeCompare(b.label, "es"));
      };

      const paisOptions = computed(() => optionFromMap(eventosPublicados.value.map((ev) => ev.pais)));
      const ciudadOptions = computed(() => optionFromMap(eventosPublicados.value.map((ev) => ev.ciudad)));
      const companiaOptions = computed(() => optionFromMap(eventosPublicados.value.map((ev) => ev.compania)));

      const activeFilters = computed(() => {
        const chips = [];
        if (filters.pais) {
          const found = paisOptions.value.find((opt) => opt.value === filters.pais);
          chips.push({ key: "pais", label: "Pa√≠s", value: found ? found.label : filters.pais });
        }
        if (filters.ciudad) {
          const found = ciudadOptions.value.find((opt) => opt.value === filters.ciudad);
          chips.push({ key: "ciudad", label: "Ciudad", value: found ? found.label : filters.ciudad });
        }
        if (filters.compania) {
          const found = companiaOptions.value.find((opt) => opt.value === filters.compania);
          chips.push({ key: "compania", label: "Compa√±√≠a", value: found ? found.label : filters.compania });
        }
        if (filters.fecha) {
          const formatted = new Date(`${filters.fecha}T00:00:00`).toLocaleDateString("es-ES", {
            day: "numeric",
            month: "short",
            year: "numeric",
          });
          chips.push({ key: "fecha", label: "Desde", value: formatted });
        }
        if (filters.search) {
          chips.push({ key: "search", label: "B√∫squeda", value: filters.search });
        }
        return chips;
      });

      const agendaEventosFiltrados = computed(() => {
        const f = filters.fecha;
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const todayTime = today.getTime();
        return eventosFiltrados.value
          .filter((ev) => {
            const isPastEvent = typeof ev.fechaTime === "number" && ev.fechaTime < todayTime;
            const okPast = !isPastEvent || (f && ev.fechaISO === f);
            return okPast;
          })
          .sort((a, b) => {
            const timeA = typeof a.fechaTime === "number" ? a.fechaTime : Number.POSITIVE_INFINITY;
            const timeB = typeof b.fechaTime === "number" ? b.fechaTime : Number.POSITIVE_INFINITY;
            if (timeA !== timeB) return timeA - timeB;
            if (a.horaValue !== b.horaValue) return a.horaValue - b.horaValue;
            return a.nombre.localeCompare(b.nombre, "es");
          });
      });

      const agendaResultsLabel = computed(() => {
        if (cargando.value) return "Cargando‚Ä¶";
        const count = agendaEventosFiltrados.value.length;
        return `${count} ${count === 1 ? "resultado" : "resultados"}`;
      });

      const totalEventosAgenda = totalEventos;
      const totalPaisesAgenda = computed(
        () => new Set(eventosPublicados.value.map((ev) => ev.pais).filter(Boolean)).size
      );
      const eventosMesAgenda = computed(() => {
        if (!eventosPublicados.value.length) return 0;
        const now = new Date();
        const month = now.getMonth();
        const year = now.getFullYear();
        return eventosPublicados.value.filter((ev) => {
          if (!ev.fechaRaw) return false;
          const d = new Date(ev.fechaRaw);
          if (Number.isNaN(d.getTime())) return false;
          return d.getMonth() === month && d.getFullYear() === year;
        }).length;
      });

      const removeFilter = (key) => {
        if (Object.prototype.hasOwnProperty.call(filters, key)) {
          filters[key] = "";
        }
      };

      const applyDetectedCountry = () => {
        if (filters.pais || !detectedCountry.value) return;
        const normalized = normalizeText(detectedCountry.value);
        if (!normalized) return;
        const found = paisOptions.value.find((opt) => opt.value === normalized);
        if (found) {
          filters.pais = found.value;
        }
      };

      const detectCountry = async () => {
        try {
          const response = await fetch("https://ipapi.co/json/");
          if (!response.ok) return;
          const data = await response.json();
          detectedCountry.value = data.country_name || data.country || "";
          applyDetectedCountry();
        } catch (err) {
          console.warn("No se pudo determinar el pa√≠s del visitante", err);
        }
      };

      watch(paisOptions, applyDetectedCountry);

      watch(
        bogotaEventos,
        () => {
          if (vista.value !== "map") return;
          prepareMapLocations();
          nextTick(() => {
            ensureMap();
            updateMapMarkers();
          });
        },
        { deep: true }
      );

      watch(
        eventLocations,
        () => {
          if (vista.value === "map") {
            updateMapMarkers();
          }
        },
        { deep: true }
      );

      watch(vista, (value) => {
        if (value === "map") {
          nextTick(() => {
            ensureMap();
            prepareMapLocations();
            updateMapMarkers();
            processGeocodeQueue();
          });
        }
      });

      const downloadAgendaPdf = async () => {
        if (typeof window === "undefined") return;
        if (typeof html2pdf === "undefined") {
          console.error("La librer√≠a html2pdf no est√° disponible en este navegador.");
          return;
        }
        if (downloadingAgendaPdf.value) return;
        downloadingAgendaPdf.value = true;

        const removeContainer = (container) => {
          if (container && container.parentNode) {
            container.parentNode.removeChild(container);
          }
        };

        const printable = document.createElement("div");
        printable.style.position = "fixed";
        printable.style.left = "-9999px";
        printable.style.top = "0";
        printable.style.width = "210mm";
        printable.style.maxWidth = "100%";
        printable.style.padding = "24px";
        printable.style.backgroundColor = "#ffffff";
        printable.style.color = "#101828";
        printable.style.fontFamily = "'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        printable.style.lineHeight = "1.4";

        const title = document.createElement("h1");
        title.textContent = "Agenda ImproWorld";
        title.style.textAlign = "center";
        title.style.margin = "0 0 6px";
        printable.appendChild(title);

        const generatedAt = document.createElement("p");
        generatedAt.textContent = `Generado el ${new Date().toLocaleDateString("es-ES", { dateStyle: "full" })}`;
        generatedAt.style.textAlign = "center";
        generatedAt.style.margin = "0 0 18px";
        generatedAt.style.color = "#475467";
        printable.appendChild(generatedAt);

        const totals = document.createElement("p");
        totals.textContent = `Mostrando ${agendaEventosFiltrados.value.length} de ${eventosPublicados.value.length} eventos disponibles.`;
        totals.style.margin = "0 0 12px";
        printable.appendChild(totals);

        const filtersParagraph = document.createElement("p");
        filtersParagraph.style.margin = "0 0 20px";
        filtersParagraph.textContent = activeFilters.value.length
          ? `Filtros aplicados: ${activeFilters.value.map((chip) => `${chip.label}: ${chip.value}`).join(", ")}`
          : "Filtros aplicados: ninguno";
        printable.appendChild(filtersParagraph);

        const events = agendaEventosFiltrados.value;

        if (!events.length) {
          const empty = document.createElement("p");
          empty.textContent = "No hay eventos disponibles con los filtros seleccionados.";
          empty.style.marginTop = "24px";
          printable.appendChild(empty);
        } else {
          const table = document.createElement("table");
          table.style.width = "100%";
          table.style.borderCollapse = "collapse";
          table.style.fontSize = "11pt";

          const thead = document.createElement("thead");
          const headerRow = document.createElement("tr");
          const headers = ["Evento", "Fecha", "Hora", "Lugar", "Ciudad", "Pa√≠s", "Compa√±√≠a"];
          headers.forEach((label) => {
            const th = document.createElement("th");
            th.textContent = label;
            th.style.border = "1px solid #e2e8f0";
            th.style.padding = "8px";
            th.style.backgroundColor = "#f8fafc";
            th.style.color = "#344054";
            th.style.textAlign = "left";
            th.style.fontWeight = "600";
            headerRow.appendChild(th);
          });
          thead.appendChild(headerRow);
          table.appendChild(thead);

          const tbody = document.createElement("tbody");

          events.forEach((ev) => {
            const row = document.createElement("tr");

            const eventCell = document.createElement("td");
            eventCell.style.border = "1px solid #e2e8f0";
            eventCell.style.padding = "10px";
            eventCell.style.verticalAlign = "top";

            const name = document.createElement("div");
            name.textContent = ev.nombre;
            name.style.fontWeight = "600";
            name.style.marginBottom = "4px";
            eventCell.appendChild(name);

            const info = document.createElement("div");
            info.textContent = `${ev.lugarLabel || ""}`;
            info.style.fontSize = "0.85rem";
            info.style.color = "#475467";
            eventCell.appendChild(info);

            if (ev.boleteria) {
              const ticket = document.createElement("div");
              ticket.textContent = `Boleter√≠a: ${ev.boleteria}`;
              ticket.style.marginTop = "6px";
              ticket.style.fontSize = "0.85rem";
              ticket.style.color = "#475467";
              eventCell.appendChild(ticket);
            }

            row.appendChild(eventCell);

            const createTextCell = (value) => {
              const cell = document.createElement("td");
              cell.textContent = value || "‚Äî";
              cell.style.border = "1px solid #e2e8f0";
              cell.style.padding = "8px";
              cell.style.verticalAlign = "top";
              cell.style.whiteSpace = "pre-wrap";
              return cell;
            };

            row.appendChild(createTextCell(ev.fechaLabel || ev.fechaISO || ""));
            row.appendChild(createTextCell(ev.horaLabel));
            row.appendChild(createTextCell(ev.lugarLabel));
            row.appendChild(createTextCell(ev.ciudad));
            row.appendChild(createTextCell(ev.pais));
            row.appendChild(createTextCell(ev.compania));

            tbody.appendChild(row);
          });

          table.appendChild(tbody);
          printable.appendChild(table);
        }

        document.body.appendChild(printable);

        const filenameDate = new Date().toISOString().split("T")[0];
        const options = {
          margin: 10,
          filename: `agenda-improworld-${filenameDate}.pdf`,
          image: { type: "jpeg", quality: 0.95 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "mm", format: "a4", orientation: "portrait" },
          pagebreak: { mode: ["avoid-all", "css", "legacy"] },
        };

        try {
          await html2pdf().set(options).from(printable).save();
        } catch (err) {
          console.error("No fue posible generar el PDF de la agenda", err);
        } finally {
          downloadingAgendaPdf.value = false;
          removeContainer(printable);
        }
      };

      async function cargar() {
        cargando.value = true;
        error.value = "";
        try {
          const response = await fetch(WEBAPP_URL);
          if (!response.ok) {
            throw new Error(`No se pudo cargar la agenda (${response.status})`);
          }
          const data = await response.json();
          lista.value = Array.isArray(data) ? data.map(norm) : [];
          ultimaActualizacion.value = new Date().toLocaleDateString("es-ES", { dateStyle: "long" });
          applyDetectedCountry();
        } catch (err) {
          console.error("Error al cargar la agenda", err);
          error.value = "No fue posible cargar los eventos. Intenta de nuevo m√°s tarde.";
          lista.value = [];
        } finally {
          cargando.value = false;
        }
      }

      onMounted(() => {
        cargar();
        detectCountry();
        if (flyerDialog.value) {
          flyerDialog.value.addEventListener("close", handleFlyerDialogClose);
        }
      });

      onBeforeUnmount(() => {
        if (flyerDialog.value) {
          flyerDialog.value.removeEventListener("close", handleFlyerDialogClose);
        }
      });

      return {
        cargando,
        error,
        cambiarMes,
        mesActualLabel,
        mesActualCorto,
        totalEventos,
        ultimaActualizacion,
        vista,
        diasDelMes,
        filters,
        filtersExpanded,
        toggleFilters,
        filtersToggleLabel,
        paisOptions,
        ciudadOptions,
        companiaOptions,
        activeFilters,
        agendaResultsLabel,
        agendaEventosFiltrados,
        totalEventosAgenda,
        totalPaisesAgenda,
        eventosMesAgenda,
        removeFilter,
        downloadAgendaPdf,
        downloadingAgendaPdf,
        hoyISO,
        fechaLarga,
        diaSemanaCorta,
        descripcionFila,
        openFlyer,
        closeFlyer,
        flyerDialogData,
        flyerDialog,
        mapContainer,
        mapReady,
        mapError,
        mapWarnings,
        bogotaEventos,
      };
    }
  })
    .directive("img-fallback", {
      mounted(el, binding) {
        mountImageWithFallback(el, binding.value);
      },
      updated(el, binding) {
        mountImageWithFallback(el, binding.value);
      },
    })
    .mount("#app");
  </script>
</body>
</html>
