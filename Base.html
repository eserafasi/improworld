<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda de Eventos</title>
  <style>
    :root {
      --ink: #101828;
      --muted: #667085;
      --bg: #f8fafc;
      --card: #ffffff;
      --ring: #e2e8f0;
      --primary: #7c3aed;
      --primary-soft: #ede9fe;
      --accent: #f59e0b;
      --accent-soft: rgba(245, 158, 11, 0.14);
      --success: #22c55e;
      --shadow-sm: 0 1px 3px rgba(15, 23, 42, 0.08);
      --shadow-md: 0 12px 32px rgba(79, 70, 229, 0.12);
      --radius-lg: 18px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --max-width: 1200px;
      --transition: all 0.25s ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, #faf5ff 0%, #f8fafc 40%, #ffffff 100%);
      color: var(--ink);
      margin: 0;
    }

    h1, h2, h3 {
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--ink);
      margin: 0;
    }

    .page {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .hero {
      padding: 72px 20px 40px;
      background: radial-gradient(120% 120% at 50% 0%, rgba(124, 58, 237, 0.16) 0%, rgba(124, 58, 237, 0) 60%),
        linear-gradient(140deg, rgba(124, 58, 237, 0.16) 10%, rgba(59, 130, 246, 0.08) 100%);
    }

    .hero__inner {
      max-width: var(--max-width);
      margin: 0 auto;
      display: grid;
      gap: 28px;
      grid-template-columns: minmax(0, 1fr) auto;
      align-items: start;
    }

    .hero__heading {
      font-size: clamp(2.25rem, 5vw, 3.2rem);
      letter-spacing: -0.03em;
      line-height: 1.1;
      max-width: 16ch;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .hero__logo {
      display: flex;
      align-items: flex-end;
      flex-wrap: wrap;
      gap: 12px;
    }

    .hero__logo img {
      height: clamp(48px, 10vw, 92px);
      width: auto;
      display: block;
    }

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .hero__description {
      color: rgba(16, 24, 40, 0.72);
      font-size: 1rem;
      max-width: 48ch;
    }

    .hero__metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(110px, 1fr));
      gap: 12px;
      justify-self: end;
      width: 100%;
      max-width: 420px;
      transition: transform 0.25s ease;
    }

    .metric {
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(12px);
      border-radius: var(--radius-md);
      padding: 12px 14px;
      border: 1px solid rgba(124, 58, 237, 0.14);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .metric__value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--primary);
      transition: font-size 0.25s ease;
    }

    .metric__label {
      color: var(--muted);
      font-size: 0.8rem;
      transition: font-size 0.25s ease;
    }

    @media (min-width: 901px) {
      .hero__metrics {
        transform: translateY(-30px);
      }
    }

    .wrap {
      max-width: var(--max-width);
      margin: -40px auto 60px;
      padding: 0 20px 60px;
      width: 100%;
    }

    @media (max-width: 768px) {
      .hero {
        padding: 48px 16px 28px;
      }

      .hero__inner {
        grid-template-columns: 1fr;
        gap: 18px;
      }

      .hero__heading {
        font-size: 1.9rem;
        line-height: 1.15;
        max-width: 100%;
      }

      .hero__description {
        font-size: 0.95rem;
        line-height: 1.4;
        max-width: 40ch;
      }

      .hero__metrics {
        justify-self: stretch;
        max-width: none;
        grid-template-columns: repeat(3, minmax(0, 1fr));
        gap: 10px;
      }

      .metric {
        padding: 10px 12px;
        gap: 2px;
      }

      .metric__value {
        font-size: 1.3rem;
      }

      .metric__label {
        font-size: 0.72rem;
      }
    }

    @media (max-width: 480px) {
      .hero {
        padding: 40px 14px 24px;
      }

      .hero__heading {
        font-size: 1.6rem;
        line-height: 1.1;
      }

      .hero__description {
        font-size: 0.85rem;
        max-width: 32ch;
      }

      .hero__metrics {
        gap: 8px;
      }

      .metric {
        padding: 8px 10px;
      }

      .metric__value {
        font-size: 1.15rem;
      }

      .metric__label {
        font-size: 0.68rem;
      }
    }

    .filters-card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: 28px;
      box-shadow: var(--shadow-md);
      border: 1px solid rgba(124, 58, 237, 0.08);
      display: grid;
      gap: 20px;
      margin-bottom: 36px;
      transition: var(--transition);
    }

    .filters-card.is-collapsed {
      padding-bottom: 22px;
    }

    .filters-card.is-collapsed .filters {
      display: none;
    }

    .filters-card__header {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 16px;
      justify-content: space-between;
      align-items: center;
    }

    .filters-card__title {
      font-size: 1.35rem;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filters-card__title span {
      display: inline-flex;
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: var(--primary-soft);
      color: var(--primary);
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .filters-card__meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 12px;
      align-items: center;
      justify-content: flex-end;
      margin-left: auto;
    }

    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .filters label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--muted);
      font-weight: 600;
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }

    .filters select,
    .filters input {
      padding: 10px 12px;
      border: 1px solid var(--ring);
      border-radius: 12px;
      font-size: 0.95rem;
      background: rgba(248, 250, 252, 0.9);
      transition: var(--transition);
      color: var(--ink);
    }

    .filters select:focus,
    .filters input:focus {
      outline: none;
      border-color: rgba(124, 58, 237, 0.4);
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.12);
    }

    .filter-summary {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }

    .filter-summary__count {
      font-weight: 600;
      color: var(--muted);
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--primary-soft);
      color: var(--primary);
      border-radius: 999px;
      font-size: 0.85rem;
      font-weight: 600;
      border: 1px solid rgba(124, 58, 237, 0.2);
    }

    .chip button {
      background: transparent;
      border: none;
      color: inherit;
      cursor: pointer;
      padding: 0;
      font-size: 1rem;
      line-height: 1;
    }

    .filters-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(124, 58, 237, 0.18);
      background: rgba(124, 58, 237, 0.08);
      color: var(--primary);
      font-weight: 600;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
    }

    .filters-toggle:hover,
    .filters-toggle:focus-visible {
      background: rgba(124, 58, 237, 0.16);
      outline: none;
      box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.18);
    }

    .filters-toggle__icon {
      display: inline-flex;
      transition: transform 0.2s ease;
    }

    .filters-card.is-collapsed .filters-toggle__icon {
      transform: rotate(-90deg);
    }

    .agenda {
      column-width: 320px;
      column-gap: 24px;
      width: 100%;
    }

    .agenda__list {
      display: contents;
    }

    .agenda > article,
    .agenda__list > article,
    .agenda > .skeleton-card,
    .agenda__list > .skeleton-card,
    .card,
    .skeleton-card {
      break-inside: avoid;
      margin-bottom: 24px;
      width: 100%;
    }

    .card {
      position: relative;
      border-radius: var(--radius-lg);
      overflow: hidden;
      background: var(--card);
      box-shadow: var(--shadow-sm);
      border: 1px solid rgba(148, 163, 184, 0.25);
      display: flex;
      flex-direction: column;
      transition: transform 0.35s ease, box-shadow 0.35s ease;
    }

    .card:hover {
      transform: translateY(-6px);
      box-shadow: 0 20px 36px rgba(15, 23, 42, 0.18);
    }

    .thumb {
      width: 100%;
      aspect-ratio: var(--img-aspect, 4 / 3);
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.12), rgba(14, 165, 233, 0.12));
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .thumb img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .thumb__overlay {
      position: absolute;
      inset: 0;
      background: linear-gradient(180deg, rgba(15, 23, 42, 0) 40%, rgba(15, 23, 42, 0.75) 100%);
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      padding: 16px;
      pointer-events: none;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 700;
      letter-spacing: 0.03em;
      text-transform: uppercase;
      backdrop-filter: blur(12px);
    }

    .badge--format {
      background: rgba(252, 231, 243, 0.85);
      color: #db2777;
      align-self: flex-start;
    }

    .badge--country {
      background: rgba(14, 165, 233, 0.24);
      color: #0ea5e9;
      align-self: flex-end;
    }

    .content {
      padding: 20px 22px 24px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      flex: 1;
    }

    h3 {
      font-size: 1.2rem;
      line-height: 1.3;
      font-weight: 700;
    }

    .meta {
      color: var(--muted);
      font-size: 0.95rem;
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 0;
    }

    .meta strong {
      color: var(--ink);
      font-weight: 600;
    }

    .actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .btn {
      border-radius: 12px;
      padding: 10px 16px;
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      text-align: center;
      text-decoration: none;
      flex: 1;
      transition: var(--transition);
    }

    .btn-primary {
      background: linear-gradient(135deg, #7c3aed, #6366f1);
      color: #fff;
      border: none;
      box-shadow: 0 12px 24px rgba(124, 58, 237, 0.25);
    }

    .btn-primary:hover {
      filter: brightness(1.05);
      transform: translateY(-1px);
    }

    .btn-secondary {
      background: rgba(245, 158, 11, 0.14);
      color: #b45309;
      border: 1px solid rgba(245, 158, 11, 0.4);
    }

    .btn-secondary:hover {
      background: rgba(245, 158, 11, 0.22);
    }

    .empty-state {
      background: rgba(255, 255, 255, 0.9);
      border: 1px dashed rgba(124, 58, 237, 0.3);
      border-radius: var(--radius-lg);
      padding: 48px;
      text-align: center;
      color: var(--muted);
      display: grid;
      gap: 12px;
    }

    .empty-state strong {
      color: var(--primary);
      font-size: 1.1rem;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.65);
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
      z-index: 1000;
    }

    .modal__dialog {
      background: var(--card);
      border-radius: var(--radius-lg);
      max-width: 760px;
      width: 100%;
      max-height: 92vh;
      overflow: auto;
      box-shadow: 0 30px 60px rgba(15, 23, 42, 0.25);
      display: flex;
      flex-direction: column;
      border: 1px solid rgba(148, 163, 184, 0.26);
    }

    .modal__header,
    .modal__footer {
      padding: 20px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .modal__header {
      border-bottom: 1px solid var(--ring);
    }

    .modal__footer {
      border-top: 1px solid var(--ring);
      justify-content: flex-end;
    }

    .modal__title {
      font-size: 1.4rem;
      font-weight: 700;
    }

    .modal__close {
      background: transparent;
      border: none;
      font-size: 1.8rem;
      line-height: 1;
      cursor: pointer;
      color: var(--muted);
      transition: var(--transition);
    }

    .modal__close:hover {
      color: var(--ink);
      transform: rotate(6deg);
    }

    .modal__body {
      padding: 24px;
      display: grid;
      gap: 18px;
    }

    .modal-hero {
      width: 100%;
      aspect-ratio: var(--img-aspect, 16 / 9);
      border-radius: var(--radius-md);
      overflow: hidden;
      background: #f1f5f9;
      display: flex;
      align-items: center;
      justify-content: center;
      max-height: min(70vh, 520px);
    }

    .modal-hero img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      display: block;
    }

    .modal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px 20px;
    }

    .modal-grid p {
      margin: 0;
      font-size: 0.95rem;
      line-height: 1.5;
      color: var(--muted);
    }

    .modal-grid p strong {
      color: var(--ink);
      font-weight: 600;
    }

    /* Skeleton loading placeholders (shimmer animation) */
    .skeleton-card {
      pointer-events: none;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(148, 163, 184, 0.08), rgba(226, 232, 240, 0.24));
      overflow: hidden;
      display: flex;
      flex-direction: column;
      gap: 0;
      min-height: 320px;
    }

    .skeleton-thumb {
      height: 180px;
      background: linear-gradient(90deg, rgba(226, 232, 240, 0.6), rgba(148, 163, 184, 0.4), rgba(226, 232, 240, 0.6));
      background-size: 200% 100%;
      animation: shimmer 1.8s ease-in-out infinite;
    }

    .skeleton-body {
      padding: 20px;
      display: grid;
      gap: 12px;
    }

    .skeleton-line {
      height: 14px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(226, 232, 240, 0.6), rgba(148, 163, 184, 0.4), rgba(226, 232, 240, 0.6));
      background-size: 200% 100%;
      animation: shimmer 1.8s ease-in-out infinite;
    }

    .skeleton-line.short {
      width: 60%;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .fade-enter-active,
    .fade-leave-active {
      transition: opacity 0.2s ease;
    }

    .fade-enter-from,
    .fade-leave-to {
      opacity: 0;
    }

    .scale-enter-active,
    .scale-leave-active {
      transition: transform 0.25s ease, opacity 0.25s ease;
    }

    .scale-enter-from,
    .scale-leave-to {
      transform: scale(0.98);
      opacity: 0;
    }

    @media (max-width: 900px) {
      .hero {
        padding-top: 56px;
      }

      .filters-card {
        padding: 22px;
      }

      .filters-card__meta {
        width: 100%;
        justify-content: space-between;
      }

      .modal__body {
        padding: 20px;
      }
    }

    @media (max-width: 640px) {
      .hero {
        padding: 36px 16px 20px;
      }

      .wrap {
        margin-top: -40px;
      }

      .hero__inner {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .hero__logo {
        gap: 8px;
      }

      .hero__logo img {
        height: clamp(36px, 9vw, 56px);
      }

      .hero__heading {
        font-size: 1.85rem;
        gap: 6px;
      }

      .hero__description {
        font-size: 0.85rem;
        line-height: 1.45;
        margin-top: 6px;
      }

      .hero__metrics {
        justify-self: stretch;
        max-width: none;
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 4px;
        transform: translateY(0);
      }

      .hero__metrics::-webkit-scrollbar {
        display: none;
      }

      .metric {
        flex: 1 0 160px;
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        padding: 8px 10px;
      }

      .metric__value {
        font-size: 1.05rem;
      }

      .metric__label {
        font-size: 0.65rem;
        white-space: nowrap;
      }

      .filters-card {
        padding: 16px;
        gap: 14px;
      }

      .filters-card__header {
        gap: 8px;
      }

      .filters-card__title {
        font-size: 1rem;
      }

      .filters-card__title span {
        width: 28px;
        height: 28px;
        font-size: 0.95rem;
      }

      .filters-card__meta {
        flex-direction: column;
        align-items: stretch;
        gap: 8px;
      }

      .filter-summary {
        gap: 6px;
      }

      .filter-summary__count {
        font-size: 0.78rem;
      }

      .chip {
        padding: 4px 8px;
        font-size: 0.72rem;
      }

      .filters {
        grid-template-columns: 1fr;
      }

      .filters-toggle {
        justify-content: center;
        font-size: 0.78rem;
        padding: 6px 10px;
      }

      .filters label {
        font-size: 0.78rem;
      }

      .actions {
        flex-direction: column;
      }
    }
  </style>
</head>
<body>
<div id="app" class="page">
  <header class="hero">
    <div class="hero__inner">
      <div>
        <h1 class="hero__heading">
          <span class="sr-only">Agenda ImproWorld</span>
          <span class="hero__logo" aria-hidden="true">
            <img src="https://drive.google.com/uc?export=view&id=1l_hsaNH2OXG6ZiF5ervFpOvtcaGLMiiQ" alt="">
            <img src="https://drive.google.com/uc?export=view&id=1RSrq-315cEHzVa0LelzEKfassWhtK_Nu" alt="">
          </span>
        </h1>
        <p class="hero__description">
          Encuentra las pr√≥ximas funciones, talleres y experiencias de improvisaci√≥n en toda la regi√≥n.
          Filtra por pa√≠s, ciudad o compa√±√≠a y mantente al d√≠a con la comunidad.
        </p>
      </div>
      <div class="hero__metrics">
        <article class="metric">
          <span class="metric__value">{{ totalEvents }}</span>
          <span class="metric__label">Eventos activos en ImproWorld</span>
        </article>
        <article class="metric">
          <span class="metric__value">{{ totalCountries }}</span>
          <span class="metric__label">Pa√≠ses representados</span>
        </article>
        <article class="metric">
          <span class="metric__value">{{ thisMonthEvents }}</span>
          <span class="metric__label">Eventos este mes</span>
        </article>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="filters-card" :class="{ 'is-collapsed': !filtersExpanded }">
      <header class="filters-card__header">
        <h2 class="filters-card__title"><span>üéüÔ∏è</span> Filtrar agenda</h2>
        <div class="filters-card__meta">
          <div class="filter-summary">
            <span class="filter-summary__count">{{ resultsLabel }}</span>
            <template v-for="chip in activeFilters" :key="chip.key">
              <span class="chip">
                {{ chip.label }}: {{ chip.value }}
                <button type="button" @click="removeFilter(chip.key)" aria-label="Quitar filtro">&times;</button>
              </span>
            </template>
          </div>
          <button
            type="button"
            class="filters-toggle"
            @click="toggleFilters"
            :aria-expanded="filtersExpanded"
            aria-controls="filters-panel"
          >
            <span class="filters-toggle__icon" aria-hidden="true">‚ñæ</span>
            {{ filtersToggleLabel }}
          </button>
        </div>
      </header>
      <div class="filters" id="filters-panel" :aria-hidden="!filtersExpanded">
        <label for="fPais">
          Pa√≠s
          <select id="fPais" v-model="filters.pais">
            <option value="">Todos los pa√≠ses</option>
            <option v-for="opt in paisOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
          </select>
        </label>
        <label for="fCiudad">
          Ciudad
          <select id="fCiudad" v-model="filters.ciudad">
            <option value="">Todas las ciudades</option>
            <option v-for="opt in ciudadOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
          </select>
        </label>
        <label for="fCompania">
          Compa√±√≠a
          <select id="fCompania" v-model="filters.compania">
            <option value="">Todas las compa√±√≠as</option>
            <option v-for="opt in companiaOptions" :key="opt.value" :value="opt.value">{{ opt.label }}</option>
          </select>
        </label>
        <label for="fFecha">
          Fecha
          <input id="fFecha" type="date" v-model="filters.fecha">
        </label>
        <label for="fSearch">
          B√∫squeda
          <input id="fSearch" type="text" v-model="filters.search" placeholder="Buscar por t√≠tulo, lugar o compa√±√≠a">
        </label>
      </div>
    </section>

    <section>
      <div class="agenda" id="agenda">
        <template v-if="loading">
          <article v-for="n in 6" :key="n" class="skeleton-card">
            <div class="skeleton-thumb"></div>
            <div class="skeleton-body">
              <span class="skeleton-line"></span>
              <span class="skeleton-line"></span>
              <span class="skeleton-line short"></span>
            </div>
          </article>
        </template>
        <template v-else>
          <transition-group name="scale" tag="div" class="agenda__list">
            <article v-for="event in filteredEvents" :key="event.id" class="card">
              <div class="thumb" v-img-fallback="event.piezaCands">
                <div class="thumb__overlay">
                  <span class="badge badge--format" v-if="event.formato">{{ event.formato }}</span>
                  <span class="badge badge--country" v-if="event.pais">{{ event.pais }}</span>
                </div>
              </div>
              <div class="content">
                <h3>{{ event.nombre }}</h3>
                <p class="meta">
                  <strong>Fecha</strong>
                  <span>{{ event.fecha || 'Por confirmar' }}</span>
                </p>
                <p class="meta">
                  <strong>Hora</strong>
                  <span>{{ event.hora || 'Por definir' }}</span>
                </p>
                <p class="meta">
                  <strong>Lugar</strong>
                  <span>{{ event.lugar || 'Pronto' }}</span>
                </p>
                <div class="actions">
                  <button type="button" class="btn btn-primary" @click="openModal(event)">Ver m√°s</button>
                  <a v-if="event.boleteria" :href="event.boleteria" target="_blank" rel="noopener" class="btn btn-secondary">Boleter√≠a</a>
                </div>
              </div>
            </article>
          </transition-group>
          <div v-if="!filteredEvents.length" class="empty-state">
            <strong>No encontramos eventos con esos filtros.</strong>
            <span>Prueba ajustando la b√∫squeda o borra los filtros activos para ver toda la programaci√≥n.</span>
          </div>
        </template>
      </div>
    </section>
  </main>

  <transition name="fade">
    <div v-if="showModal" class="modal" role="dialog" aria-modal="true" @click.self="closeModal">
      <article class="modal__dialog">
        <header class="modal__header">
          <h3 class="modal__title">{{ activeEvent ? activeEvent.nombre : '' }}</h3>
          <button class="modal__close" @click="closeModal" aria-label="Cerrar">&times;</button>
        </header>
        <div class="modal__body">
          <div class="modal-hero" v-img-fallback="activeEvent ? activeEvent.piezaCands : []"></div>
          <div class="modal-grid" v-if="activeEvent">
            <p><strong>Formato:</strong> {{ activeEvent.formato || '‚Äî' }}</p>
            <p><strong>Pa√≠s:</strong> {{ activeEvent.pais || '‚Äî' }}</p>
            <p><strong>Ciudad:</strong> {{ activeEvent.ciudad || '‚Äî' }}</p>
            <p><strong>Compa√±√≠a:</strong> {{ activeEvent.compania || '‚Äî' }}</p>
            <p><strong>Director:</strong> {{ activeEvent.director || '‚Äî' }}</p>
            <p><strong>Lugar:</strong> {{ activeEvent.lugar || '‚Äî' }}</p>
            <p><strong>Fecha:</strong> {{ activeEvent.fecha || '‚Äî' }}</p>
            <p><strong>Hora funci√≥n:</strong> {{ activeEvent.hora || '‚Äî' }}</p>
            <p><strong>Apertura:</strong> {{ activeEvent.apertura || '‚Äî' }}</p>
            <p>
              <strong>Instagram:</strong>
              <template v-if="activeEvent.igUser">
                <a :href="`https://instagram.com/${activeEvent.igUser}`" target="_blank" rel="noopener">@{{ activeEvent.igUser }}</a>
              </template>
              <template v-else>‚Äî</template>
            </p>
            <p>
              <strong>Video:</strong>
              <template v-if="activeEvent.video">
                <a :href="activeEvent.video" target="_blank" rel="noopener">Ver video</a>
              </template>
              <template v-else>‚Äî</template>
            </p>
            <p style="grid-column: 1 / -1;">
              <strong>Sinopsis:</strong> {{ activeEvent.sinopsis || '‚Äî' }}
            </p>
          </div>
        </div>
        <footer class="modal__footer">
          <a v-if="activeEvent && activeEvent.boleteria" :href="activeEvent.boleteria" target="_blank" rel="noopener" class="btn btn-primary">Comprar boletos</a>
          <button class="btn btn-secondary" type="button" @click="closeModal">Cerrar</button>
        </footer>
      </article>
    </div>
  </transition>
</div>

<script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
<script>
const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbwoCLUfEiRjnmzumQ-Qs82vLUMpfTWHuemY8W6NODHVhGskbdQQHh-rIHKJUpS0cPCSxQ/exec";

function normalizeText(t) {
  return t ? t.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase() : "";
}

function val(x) {
  return (x === undefined || x === null) ? "" : String(x).trim();
}

function formatFecha(v) {
  if (!v) return "";
  const d = new Date(v);
  if (isNaN(d)) return v;
  return d.toLocaleDateString("es-ES", { day: "numeric", month: "short", year: "numeric" });
}

function extractDriveId(u) {
  if (!u) return "";
  let m;
  if ((m = u.match(/[?&]id=([-\w]+)/))) return m[1];
  if ((m = u.match(/\/d\/([-\w]+)/))) return m[1];
  return "";
}

function driveImageCandidates(u) {
  const id = extractDriveId(u);
  return id ? [
    `https://drive.google.com/uc?export=view&id=${id}`,
    `https://drive.google.com/thumbnail?id=${id}&sz=w1200`,
    `https://lh3.googleusercontent.com/d/${id}=w1200`
  ] : (u ? [u] : []);
}

function createImgWithFallback(cands) {
  const img = document.createElement("img");
  img.dataset.vImgFallback = "true";
  img.loading = "lazy";
  img.decoding = "async";
  let i = 0;
  const resetAspect = () => {
    if (img.parentElement) {
      img.parentElement.style.removeProperty("--img-aspect");
    }
  };
  img.addEventListener("load", () => {
    if (!img.parentElement) return;
    const { naturalWidth, naturalHeight } = img;
    if (naturalWidth > 0 && naturalHeight > 0) {
      const ratio = naturalWidth / naturalHeight;
      if (isFinite(ratio) && ratio > 0) {
        img.parentElement.style.setProperty("--img-aspect", ratio);
      }
    }
  });
  const tryNext = () => {
    if (!Array.isArray(cands) || i >= cands.length) {
      img.onerror = null;
      resetAspect();
      img.src = "https://via.placeholder.com/800?text=Sin+imagen";
      return;
    }
    resetAspect();
    img.src = cands[i++];
  };
  img.onerror = tryNext;
  tryNext();
  return img;
}

function createFallbackId() {
  try {
    if (typeof crypto !== "undefined" && typeof crypto.randomUUID === "function") {
      return crypto.randomUUID();
    }
  } catch (err) {
    /* ignore */
  }
  return `event-${Date.now()}-${Math.random().toString(16).slice(2)}`;
}

function norm(ev) {
  const base = {
    id: val(ev.Id) || val(ev.ID) || createFallbackId(),
    nombre: val(ev.NombreFormato) || val(ev["Nombre de la Obra"]) || "Evento sin nombre",
    formato: val(ev.TipoFormato),
    fecha: formatFecha(ev.FechaFuncion),
    fechaRaw: ev.FechaFuncion,
    fechaISO: "",
    hora: val(ev.HoraFuncionTexto) || val(ev.HoraFuncion),
    apertura: val(ev.AperturaPuertasTexto) || val(ev.AperturaPuertas),
    pais: val(ev.Pais) || val(ev["Pa√≠s"]),
    ciudad: val(ev.Ciudad),
    lugar: val(ev.Lugar),
    compania: val(ev.Compania) || val(ev["Compa√±√≠a"]),
    director: val(ev.Director),
    sinopsis: val(ev.Sinopsis),
    igUser: val(ev.Instagram).replace(/^https?:\/\/(www\.)?instagram\.com\//i, "").replace(/\/.*$/, "").replace(/^@/, ""),
    boleteria: val(ev.Boleteria),
    video: val(ev.VideoURL),
    piezaCands: driveImageCandidates(val(ev.PiezaPromocional)),
    estado: val(ev.Estado) || "Publicado"
  };
  base.fechaISO = base.fechaRaw ? (() => {
    const d = new Date(base.fechaRaw);
    return isNaN(d) ? "" : d.toISOString().split("T")[0];
  })() : "";
  base.searchText = normalizeText([
    base.nombre,
    base.formato,
    base.fecha,
    base.hora,
    base.pais,
    base.ciudad,
    base.lugar,
    base.compania,
    base.director,
    base.sinopsis
  ].join(" "));
  return base;
}

const { createApp, reactive, ref, computed, onMounted, onBeforeUnmount } = Vue;

const app = createApp({
  setup() {
    const loading = ref(true);
    const list = ref([]);
    const filters = reactive({
      search: "",
      pais: "",
      ciudad: "",
      compania: "",
      fecha: ""
    });
    const showModal = ref(false);
    const activeEvent = ref(null);
    const filtersExpanded = ref(true);

    const toggleFilters = () => {
      filtersExpanded.value = !filtersExpanded.value;
    };

    const filtersToggleLabel = computed(() =>
      filtersExpanded.value ? "Ocultar filtros" : "Mostrar filtros"
    );

    const closeModal = () => {
      showModal.value = false;
      activeEvent.value = null;
    };

    const keyboardHandler = (e) => {
      if (e.key === "Escape") {
        closeModal();
      }
    };

    const filteredEvents = computed(() => {
      const q = normalizeText(filters.search);
      const p = filters.pais;
      const c = filters.ciudad;
      const co = filters.compania;
      const f = filters.fecha;
      return list.value.filter((ev) => {
        const okQ = !q || ev.searchText.includes(q);
        const okP = !p || normalizeText(ev.pais) === p;
        const okC = !c || normalizeText(ev.ciudad) === c;
        const okCo = !co || normalizeText(ev.compania) === co;
        const okF = !f || ev.fechaISO === f;
        return okQ && okP && okC && okCo && okF;
      });
    });

    const resultsLabel = computed(() => {
      if (loading.value) return "Cargando‚Ä¶";
      const count = filteredEvents.value.length;
      return `${count} ${count === 1 ? "resultado" : "resultados"}`;
    });

    const optionFromMap = (items) => {
      const map = new Map();
      items.forEach((label) => {
        if (!label) return;
        const value = normalizeText(label);
        if (!map.has(value)) {
          map.set(value, label);
        }
      });
      return Array.from(map.entries())
        .map(([value, label]) => ({ value, label }))
        .sort((a, b) => a.label.localeCompare(b.label, "es"));
    };

    const paisOptions = computed(() => optionFromMap(list.value.map((ev) => ev.pais)));
    const ciudadOptions = computed(() => optionFromMap(list.value.map((ev) => ev.ciudad)));
    const companiaOptions = computed(() => optionFromMap(list.value.map((ev) => ev.compania)));

    const activeFilters = computed(() => {
      const chips = [];
      if (filters.pais) {
        const found = paisOptions.value.find((opt) => opt.value === filters.pais);
        chips.push({ key: "pais", label: "Pa√≠s", value: found ? found.label : filters.pais });
      }
      if (filters.ciudad) {
        const found = ciudadOptions.value.find((opt) => opt.value === filters.ciudad);
        chips.push({ key: "ciudad", label: "Ciudad", value: found ? found.label : filters.ciudad });
      }
      if (filters.compania) {
        const found = companiaOptions.value.find((opt) => opt.value === filters.compania);
        chips.push({ key: "compania", label: "Compa√±√≠a", value: found ? found.label : filters.compania });
      }
      if (filters.fecha) {
        const formatted = new Date(filters.fecha + "T00:00:00").toLocaleDateString("es-ES", { day: "numeric", month: "short", year: "numeric" });
        chips.push({ key: "fecha", label: "Fecha", value: formatted });
      }
      if (filters.search) {
        chips.push({ key: "search", label: "B√∫squeda", value: filters.search });
      }
      return chips;
    });

    const totalEvents = computed(() => list.value.length);
    const totalCountries = computed(() => new Set(list.value.map((ev) => ev.pais).filter(Boolean)).size);
    const thisMonthEvents = computed(() => {
      if (!list.value.length) return 0;
      const now = new Date();
      const month = now.getMonth();
      const year = now.getFullYear();
      return list.value.filter((ev) => {
        if (!ev.fechaRaw) return false;
        const d = new Date(ev.fechaRaw);
        if (isNaN(d)) return false;
        return d.getMonth() === month && d.getFullYear() === year;
      }).length;
    });

    const removeFilter = (key) => {
      filters[key] = "";
    };

    const openModal = (event) => {
      activeEvent.value = event;
      showModal.value = true;
    };

    const loadData = async () => {
      loading.value = true;
      try {
        const response = await fetch(WEBAPP_URL);
        const data = await response.json();
        list.value = data.map(norm).filter((ev) => ev.estado !== "Despublicado");
      } catch (err) {
        console.error("Error al cargar la agenda", err);
        list.value = [];
      } finally {
        loading.value = false;
      }
    };

    onMounted(() => {
      loadData();
      if (typeof window !== "undefined") {
        filtersExpanded.value = window.innerWidth >= 900;
        window.addEventListener("keydown", keyboardHandler);
      }
    });

    onBeforeUnmount(() => {
      if (typeof window !== "undefined") {
        window.removeEventListener("keydown", keyboardHandler);
      }
    });

    return {
      loading,
      filters,
      filteredEvents,
      paisOptions,
      ciudadOptions,
      companiaOptions,
      activeFilters,
      resultsLabel,
      removeFilter,
      totalEvents,
      totalCountries,
      thisMonthEvents,
      openModal,
      closeModal,
      showModal,
      activeEvent,
      filtersExpanded,
      toggleFilters,
      filtersToggleLabel
    };
  }
});

function normalizeCandidates(value) {
  if (Array.isArray(value)) {
    return value
      .map((src) => (src == null ? "" : String(src).trim()))
      .filter(Boolean);
  }
  if (value == null) return [];
  const trimmed = String(value).trim();
  return trimmed ? [trimmed] : [];
}

function candidatesEqual(a, b) {
  if (a.length !== b.length) return false;
  for (let i = 0; i < a.length; i += 1) {
    if (a[i] !== b[i]) return false;
  }
  return true;
}

function setImageCandidates(el, candidates) {
  el.style.removeProperty("--img-aspect");
  const nextImg = createImgWithFallback(candidates);
  const currentImg = el.querySelector("img[data-v-img-fallback]");
  if (currentImg) {
    currentImg.replaceWith(nextImg);
  } else {
    el.insertBefore(nextImg, el.firstChild || null);
  }
  el.__imgFallbackCandidates = candidates.slice();
}

app.directive("img-fallback", {
  mounted(el, binding) {
    const candidates = normalizeCandidates(binding.value);
    setImageCandidates(el, candidates);
  },
  updated(el, binding) {
    const previous = Array.isArray(el.__imgFallbackCandidates)
      ? el.__imgFallbackCandidates
      : [];
    const next = normalizeCandidates(binding.value);
    if (candidatesEqual(previous, next)) {
      return;
    }
    setImageCandidates(el, next);
  }
});

app.mount("#app");
</script>
</body>
</html>
