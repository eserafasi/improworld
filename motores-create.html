<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Motores · Crear</title>
  <style>
    :root {
      --bg: #f6f4ff;
      --ink: #111827;
      --muted: #4b5563;
      --card: #ffffff;
      --primary: #7c3aed;
      --primary-soft: rgba(124, 58, 237, 0.12);
      --accent: #10b981;
      --danger: #ef4444;
      --shadow: 0 28px 60px rgba(76, 29, 149, 0.12);
      --radius-lg: 22px;
      --radius-md: 14px;
      --radius-sm: 10px;
      --max-width: 1080px;
      --transition: all 0.25s ease;
    }

    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(180deg, rgba(124, 58, 237, 0.16) 0%, rgba(236, 233, 254, 0.92) 45%, #ffffff 100%);
      color: var(--ink);
      min-height: 100vh;
    }

    h1,
    h2,
    h3 {
      margin: 0;
      font-family: inherit;
    }

    p {
      margin: 0;
      color: rgba(17, 24, 39, 0.78);
      line-height: 1.6;
    }

    a {
      color: var(--primary);
    }

    button {
      font: inherit;
      cursor: pointer;
    }

    .page {
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    .hero {
      padding: clamp(64px, 10vw, 104px) 20px 56px;
      background: radial-gradient(140% 100% at 50% 0%, rgba(255, 255, 255, 0.68) 0%, rgba(255, 255, 255, 0) 65%);
      position: relative;
      overflow: hidden;
    }

    .hero::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(160% 120% at 10% -20%, rgba(76, 29, 149, 0.18) 0%, rgba(76, 29, 149, 0) 50%);
      opacity: 0.6;
      pointer-events: none;
    }

    .hero__inner {
      position: relative;
      max-width: var(--max-width);
      margin: 0 auto;
      display: grid;
      gap: 28px;
    }

    .hero__badge {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      padding: 12px 18px;
      background: rgba(124, 58, 237, 0.16);
      border-radius: 999px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.75rem;
      color: var(--primary);
      width: fit-content;
      box-shadow: inset 0 0 0 1px rgba(124, 58, 237, 0.18);
    }

    .hero__title {
      font-size: clamp(2.6rem, 6vw, 3.8rem);
      letter-spacing: -0.02em;
      line-height: 1.08;
      max-width: 24ch;
    }

    .hero__subtitle {
      font-size: clamp(1.05rem, 2.6vw, 1.32rem);
      max-width: 48ch;
      color: rgba(17, 24, 39, 0.7);
    }

    .content {
      flex: 1;
      padding: 0 20px 80px;
    }

    .content__inner {
      max-width: var(--max-width);
      margin: -48px auto 0;
      display: grid;
      gap: 32px;
    }

    .card {
      background: var(--card);
      border-radius: var(--radius-lg);
      padding: clamp(32px, 6vw, 48px);
      box-shadow: var(--shadow);
      border: 1px solid rgba(124, 58, 237, 0.1);
      display: grid;
      gap: 28px;
    }

    .session {
      display: grid;
      gap: 18px;
    }

    .session__controls {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .session__controls input[type="text"] {
      flex: 1 1 220px;
      min-width: 180px;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(124, 58, 237, 0.2);
      background: rgba(255, 255, 255, 0.94);
      font-size: 1rem;
      transition: var(--transition);
    }

    .session__controls input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.18);
    }

    .button-primary {
      background: var(--primary);
      color: #ffffff;
      border: none;
      border-radius: var(--radius-md);
      padding: 12px 20px;
      font-weight: 600;
      transition: var(--transition);
    }

    .button-primary:hover,
    .button-primary:focus {
      background: #6d28d9;
      box-shadow: 0 10px 28px rgba(124, 58, 237, 0.24);
    }

    .button-secondary {
      background: rgba(17, 24, 39, 0.04);
      border: 1px solid rgba(17, 24, 39, 0.08);
      border-radius: var(--radius-md);
      padding: 12px 20px;
      font-weight: 500;
      color: var(--ink);
      transition: var(--transition);
    }

    .button-secondary:hover,
    .button-secondary:focus {
      border-color: rgba(17, 24, 39, 0.16);
      background: rgba(17, 24, 39, 0.08);
    }

    .button-danger {
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.22);
      color: var(--danger);
    }

    .status {
      font-size: 0.95rem;
      color: var(--muted);
    }

    .status[data-state="error"] {
      color: var(--danger);
      font-weight: 600;
    }

    .form {
      display: grid;
      gap: 18px;
    }

    .form label {
      font-weight: 600;
      color: rgba(17, 24, 39, 0.82);
    }

    textarea {
      width: 100%;
      min-height: 120px;
      padding: 14px 16px;
      font-family: inherit;
      font-size: 1.05rem;
      border-radius: var(--radius-md);
      border: 1px solid rgba(124, 58, 237, 0.2);
      resize: vertical;
      transition: var(--transition);
    }

    textarea:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.18);
    }

    .category-field {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .category-field input[type="text"] {
      flex: 1 1 200px;
      min-width: 160px;
      padding: 12px 14px;
      border-radius: var(--radius-md);
      border: 1px solid rgba(124, 58, 237, 0.2);
      background: rgba(255, 255, 255, 0.95);
      transition: var(--transition);
    }

    .category-field input[type="text"]:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 4px rgba(124, 58, 237, 0.18);
    }

    .motors-summary {
      display: grid;
      gap: 16px;
    }

    .chips {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 16px;
      border-radius: 999px;
      background: rgba(124, 58, 237, 0.08);
      color: var(--primary);
      font-weight: 600;
    }

    .chip span {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 26px;
      height: 26px;
      border-radius: 999px;
      background: rgba(124, 58, 237, 0.18);
      color: var(--primary);
      font-size: 0.85rem;
    }

    .motors-list {
      display: grid;
      gap: 16px;
      max-height: 320px;
      overflow-y: auto;
      padding-right: 6px;
    }

    .motors-list::-webkit-scrollbar {
      width: 6px;
    }

    .motors-list::-webkit-scrollbar-thumb {
      background: rgba(124, 58, 237, 0.32);
      border-radius: 999px;
    }

    .motor-item {
      padding: 16px 18px;
      background: rgba(255, 255, 255, 0.92);
      border-radius: var(--radius-md);
      border: 1px solid rgba(17, 24, 39, 0.06);
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.08);
      display: grid;
      gap: 8px;
    }

    .motor-item__category {
      font-size: 0.85rem;
      font-weight: 600;
      color: rgba(124, 58, 237, 0.9);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }

    .motor-item__text {
      font-size: 1.05rem;
      color: rgba(17, 24, 39, 0.9);
    }

    .footer-link {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 18px;
      border-radius: 999px;
      background: rgba(16, 185, 129, 0.12);
      color: #0f766e;
      font-weight: 600;
      width: fit-content;
      text-decoration: none;
      transition: var(--transition);
    }

    .footer-link:hover,
    .footer-link:focus {
      background: rgba(16, 185, 129, 0.18);
      box-shadow: 0 12px 28px rgba(16, 185, 129, 0.18);
    }

    @media (max-width: 720px) {
      .hero {
        padding: 56px 16px 40px;
      }

      .content {
        padding: 0 16px 64px;
      }

      .card {
        padding: 28px 24px;
      }

      textarea {
        min-height: 160px;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <header class="hero">
      <div class="hero__inner">
        <span class="hero__badge">Motores · Sesión compartida</span>
        <h1 class="hero__title">Crear impulsos que desaparecen al terminar el juego.</h1>
        <p class="hero__subtitle">
          Añade frases, imágenes o ideas fugaces y compártelas con el resto del grupo en tiempo real.
          Todo vive sólo durante la sesión: cuando la vacíes, será un nuevo lienzo.
        </p>
      </div>
    </header>
    <main class="content">
      <div class="content__inner">
        <section class="card session" aria-labelledby="session-heading">
          <div>
            <h2 id="session-heading">1 · Conecta la sesión</h2>
            <p>Elige un identificador breve para tu sala y compártelo. Todos los dispositivos usan el mismo nombre.</p>
          </div>
          <div class="session__controls">
            <input id="session-id" type="text" name="session" placeholder="ej. galaxia-matutina" autocomplete="off" />
            <button id="connect" class="button-primary" type="button">Conectar</button>
            <button id="disconnect" class="button-secondary" type="button" hidden>Desconectar</button>
            <button id="reset" class="button-secondary button-danger" type="button" disabled>Vaciar sesión</button>
          </div>
          <p id="status" class="status" role="status">Sin conexión.</p>
        </section>

        <section class="card" aria-labelledby="create-heading">
          <div class="form">
            <div>
              <h2 id="create-heading">2 · Escribe un motor</h2>
              <p>Comparte una imagen, emoción o detonador. Todos la verán al instante.</p>
            </div>
            <label for="motor-text">Texto</label>
            <textarea id="motor-text" placeholder="Ej. Un latido que se sincroniza con las farolas." required></textarea>
            <div class="category-field">
              <label for="motor-category">Categoría</label>
              <input id="motor-category" type="text" list="categories" placeholder="Ej. Sensaciones" autocomplete="off" />
              <datalist id="categories"></datalist>
              <button id="submit" class="button-primary" type="button" disabled>Agregar motor</button>
            </div>
          </div>
        </section>

        <section class="card motors-summary" aria-labelledby="summary-heading">
          <div>
            <h2 id="summary-heading">3 · Lo que está vivo ahora</h2>
            <p>
              Las categorías activas aparecen como chips. Mantén la sesión ligera: borra cuando terminen.
            </p>
          </div>
          <div class="chips" id="summary-chips" aria-live="polite"></div>
          <div class="motors-list" id="motors" aria-live="polite"></div>
        </section>

        <footer>
          <a id="draw-link" class="footer-link" href="motores-draw.html">Ir a la página para sacar motores →</a>
        </footer>
      </div>
    </main>
  </div>
  <script>
    (function () {
      const params = new URLSearchParams(window.location.search);
      const rootUrl = new URL("/", window.location.href);
      const sessionInput = document.getElementById("session-id");
      const connectButton = document.getElementById("connect");
      const disconnectButton = document.getElementById("disconnect");
      const resetButton = document.getElementById("reset");
      const submitButton = document.getElementById("submit");
      const statusText = document.getElementById("status");
      const textArea = document.getElementById("motor-text");
      const categoryInput = document.getElementById("motor-category");
      const categoriesDataList = document.getElementById("categories");
      const chipsContainer = document.getElementById("summary-chips");
      const motorsContainer = document.getElementById("motors");
      const drawLink = document.getElementById("draw-link");

      let websocket = null;
      let sessionId = "";
      let motors = [];
      let summary = { total: 0, categories: [] };

      const savedSession = window.localStorage.getItem("motores:session");
      const initialSession = params.get("session") || savedSession || "";
      if (initialSession) {
        sessionInput.value = initialSession;
      }

      function buildUrl(path) {
        const normalized = path.replace(/^\/+/, "");
        return new URL(normalized, rootUrl).toString();
      }

      function setStatus(message, state = "info") {
        statusText.textContent = message;
        statusText.dataset.state = state;
      }

      function setConnectedState(connected) {
        submitButton.disabled = !connected;
        resetButton.disabled = !connected;
        connectButton.hidden = connected;
        disconnectButton.hidden = !connected;
        sessionInput.readOnly = connected;
        if (connected) {
          setStatus("Conectado a la sesión " + sessionId + ".");
          window.localStorage.setItem("motores:session", sessionId);
          updateDrawLink();
        } else {
          setStatus("Sin conexión.");
          motors = [];
          summary = { total: 0, categories: [] };
          renderSummary();
          renderMotors();
          updateDrawLink();
        }
      }

      function updateDrawLink() {
        if (!sessionId) {
          drawLink.href = new URL("motores-draw.html", rootUrl).toString();
          drawLink.setAttribute("aria-disabled", "true");
          return;
        }
        drawLink.href = new URL(
          `motores-draw.html?session=${encodeURIComponent(sessionId)}`,
          rootUrl
        ).toString();
        drawLink.removeAttribute("aria-disabled");
      }

      function renderSummary() {
        chipsContainer.innerHTML = "";
        if (!summary.categories.length) {
          const empty = document.createElement("p");
          empty.textContent = "Sin motores todavía.";
          chipsContainer.appendChild(empty);
          return;
        }
        summary.categories.forEach((category) => {
          const chip = document.createElement("span");
          chip.className = "chip";
          chip.innerHTML = `${category.name}<span>${category.count}</span>`;
          chipsContainer.appendChild(chip);
        });
      }

      function renderMotors() {
        motorsContainer.innerHTML = "";
        if (!motors.length) {
          const placeholder = document.createElement("p");
          placeholder.textContent = "Aquí aparecerán los motores que estén activos.";
          motorsContainer.appendChild(placeholder);
          return;
        }
        motors
          .slice()
          .reverse()
          .forEach((motor) => {
            const article = document.createElement("article");
            article.className = "motor-item";

            const category = document.createElement("span");
            category.className = "motor-item__category";
            category.textContent = motor.category;

            const text = document.createElement("p");
            text.className = "motor-item__text";
            text.textContent = motor.text;

            article.appendChild(category);
            article.appendChild(text);
            motorsContainer.appendChild(article);
          });
      }

      function updateCategorySuggestions() {
        categoriesDataList.innerHTML = "";
        summary.categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.name;
          categoriesDataList.appendChild(option);
        });
      }

      function ensureConnected() {
        if (!sessionId) {
          setStatus("Primero conecta la sesión.", "error");
          return false;
        }
        if (!websocket || websocket.readyState !== WebSocket.OPEN) {
          setStatus("Conexión no disponible. Intenta reconectar.", "error");
          return false;
        }
        return true;
      }

      async function handleSubmit() {
        const text = textArea.value.trim();
        const category = categoryInput.value.trim();
        if (!ensureConnected()) {
          return;
        }
        if (!text) {
          setStatus("Escribe un texto antes de enviarlo.", "error");
          return;
        }
        submitButton.disabled = true;
        try {
          const response = await fetch(
            buildUrl(`api/sessions/${encodeURIComponent(sessionId)}/motors`),
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ text, category }),
            }
          );
          if (!response.ok) {
            const error = await response.json().catch(() => ({}));
            throw new Error(error.detail || "No fue posible guardar el motor.");
          }
          textArea.value = "";
          categoryInput.value = "";
          textArea.focus();
        } catch (error) {
          console.error(error);
          setStatus(error.message, "error");
        } finally {
          submitButton.disabled = false;
        }
      }

      async function handleReset() {
        if (!ensureConnected()) {
          return;
        }
        const confirmation = window.confirm("¿Vaciar la sesión por completo? Esta acción es irreversible.");
        if (!confirmation) {
          return;
        }
        resetButton.disabled = true;
        try {
          const response = await fetch(
            buildUrl(`api/sessions/${encodeURIComponent(sessionId)}/reset`),
            {
              method: "POST",
            }
          );
          if (!response.ok) {
            throw new Error("No se pudo vaciar la sesión.");
          }
        } catch (error) {
          console.error(error);
          setStatus(error.message, "error");
        } finally {
          resetButton.disabled = false;
        }
      }

      function connect() {
        const targetSession = sessionInput.value.trim();
        if (!targetSession) {
          setStatus("Escribe un nombre para la sesión.", "error");
          return;
        }
        const wsUrl = new URL(`/ws/${encodeURIComponent(targetSession)}`, rootUrl);
        wsUrl.protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        if (websocket) {
          websocket.close();
        }
        setStatus("Conectando...");
        sessionId = targetSession;
        websocket = new WebSocket(wsUrl.toString());
        websocket.addEventListener("open", () => {
          setConnectedState(true);
        });
        websocket.addEventListener("message", (event) => {
          try {
            const data = JSON.parse(event.data);
            if (data.type === "init") {
              motors = data.motors || [];
              summary = data.summary || { total: 0, categories: [] };
              renderMotors();
              renderSummary();
              updateCategorySuggestions();
              if (data.lastDrawn) {
                // no-op en esta página
              }
            } else if (data.type === "motor_added") {
              motors.push(data.motor);
              summary = data.summary || summary;
              renderMotors();
              renderSummary();
              updateCategorySuggestions();
            } else if (data.type === "reset") {
              motors = [];
              summary = { total: 0, categories: [] };
              renderMotors();
              renderSummary();
              updateCategorySuggestions();
              setStatus("La sesión quedó vacía.");
            } else if (data.type === "drawn") {
              summary = data.summary || summary;
              renderSummary();
              updateCategorySuggestions();
            }
          } catch (error) {
            console.error("Error al procesar mensaje", error);
          }
        });
        websocket.addEventListener("close", () => {
          setConnectedState(false);
        });
        websocket.addEventListener("error", () => {
          setStatus("No se pudo establecer la conexión.", "error");
        });
      }

      function disconnect() {
        if (websocket) {
          websocket.close();
        }
        websocket = null;
        sessionId = "";
        window.localStorage.removeItem("motores:session");
        sessionInput.readOnly = false;
        setConnectedState(false);
        updateDrawLink();
      }

      connectButton.addEventListener("click", connect);
      disconnectButton.addEventListener("click", disconnect);
      resetButton.addEventListener("click", handleReset);
      submitButton.addEventListener("click", handleSubmit);
      textArea.addEventListener("keydown", (event) => {
        if (event.key === "Enter" && (event.metaKey || event.ctrlKey)) {
          event.preventDefault();
          handleSubmit();
        }
      });

      sessionInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          if (sessionInput.readOnly) {
            return;
          }
          connect();
        }
      });

      if (initialSession) {
        connect();
      }
    })();
  </script>
</body>
</html>
